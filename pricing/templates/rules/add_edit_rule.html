{% extends "rules/base_rules.html" %}
{% block title %}{{ is_edit|yesno:"Edit Rule,Add Rule" }}{% endblock %}

{% block back_button %}
  <a href="{% url 'category_detail' category.id %}" class="btn">Back to Category Rules</a>
{% endblock %}

{% block content %}
<h2>{{ is_edit|yesno:"Edit Rule,Add Rule" }} for {{ category.name }}</h2>

<form method="post">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <label for="{{ form.rule_type.id_for_label }}">{{ form.rule_type.label }}</label>
  {{ form.rule_type }}

  <label for="{{ form.match_value.id_for_label }}">{{ form.match_value.label }}</label>
  {{ form.match_value }}
  {{ form.match_value.errors }}

  <label for="{{ form.adjustment.id_for_label }}">{{ form.adjustment.label }}</label>
  {{ form.adjustment }}
  {{ form.adjustment.errors }}

  <label for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
  {{ form.is_active }}
  {{ form.is_active.errors }}

  <div class="form-actions" style="margin-top:12px;">
    <button type="submit">{{ is_edit|yesno:"Update,Add" }}</button>
    <a href="{% url 'category_detail' category.id %}" class="btn">Cancel</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const ruleType = document.getElementById("id_rule_type");
  const matchValue = document.getElementById("id_match_value");

  async function updateMatchValueOptions() {
    const selectedType = ruleType.value;

    // Clear existing options
    matchValue.innerHTML = '<option value="">Loading...</option>';

    if (!selectedType) {
      matchValue.innerHTML = '<option value="">Select rule type first</option>';
      return;
    }

    try {
      const response = await fetch(`/api/get-match-values/?rule_type=${selectedType}`);
      const data = await response.json();

      matchValue.innerHTML = '<option value="">Select a value</option>';
      data.choices.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        matchValue.appendChild(opt);
      });
    } catch (error) {
      matchValue.innerHTML = '<option value="">Error loading options</option>';
      console.error("Error fetching match values:", error);
    }
  }

  ruleType.addEventListener("change", updateMatchValueOptions);

  // Initialize when editing an existing rule
  if (ruleType.value) updateMatchValueOptions();
});
</script>
{% endblock %}
