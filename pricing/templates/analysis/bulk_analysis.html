<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bulk Barcode Entry</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: 'Inter', sans-serif; background:#000; color:#fff; font-size:14px; }
  .header { padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; background:#111; }
  .header h1 { font-size:18px; font-weight:600; letter-spacing:0.5px; }
  .main-content { padding:20px; display:flex; flex-direction:column; gap:20px; max-width:100%; margin:auto; }
  input { flex:1; padding:12px; background:#1a1a1a; border:1px solid #333; color:#fff; border-radius:4px; font-size:14px; }
  input:focus { outline:none; border-color:#555; background:#222; }
  button { padding:12px 20px; background:#fff; color:#000; border:none; font-weight:600; border-radius:4px; cursor:pointer; text-transform:uppercase; }
  button:hover { background:#e6e6e6; }
  .input-row { display:flex; gap:12px; }
  .table-container { overflow-x:auto; overflow-y: auto; max-height: 70vh }
  table { width:auto; min-width: 100%; border-collapse:collapse; }
  th, td { padding:10px; border:1px solid #333; font-size:13px; }
  th { background:#1a1a1a; color:#ff; text-transform:uppercase; font-size:11px; }
  td { color:#fff; }
  .remove-btn { color:#ff6666; cursor:pointer; font-size:12px; }
  .remove-btn:hover { text-decoration:underline; }
  #scrape-status { margin-top:10px; font-size:13px; }
  #scrape-status.success { color:#8f8; }
  #scrape-status.error { color:#f88; }
  .spinner { display:inline-block; width:14px; height:14px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:6px; }
  @keyframes spin { to { transform:rotate(360deg); } }

  .view-btn {
      color: #8888ff;
      cursor: pointer;
      font-size: 12px;
  }
  .view-btn:hover {
      text-decoration: underline;
  }

</style>
</head>
<body>

<!-- Modal HTML -->
<div id="reusable-list-modal" class="hidden" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#111; padding:20px; border-radius:8px; width:400px; max-width:90%; color:#fff; display:flex; flex-direction:column; gap:12px;">
    <h2 style="margin-bottom:10px;">Confirm & List Item</h2>
    <div class="modal-fields" style="display:flex; flex-direction:column; gap:10px;"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button class="modal-close">Cancel</button>
      <button class="modal-submit">List Item</button>
    </div>
  </div>
</div>

<div class="header" style="display:flex; align-items:center; gap:12px;">
  <a href="{% url 'home' %}" class="menu-card" style="
      padding:6px 12px;
      background:#444;
      color:#fff;
      border-radius:4px;
      text-decoration:none;
      font-size:12px;
  ">BACK TO HOME PAGE</a>


  <h1>BULK BARCODE ENTRY</h1>
  <div style="font-size:11px; color:#666;">CASH GENERATOR SYSTEM</div>
</div>

<div class="main-content">

  <div class="input-row">
    <input type="text" id="barcodeInput" placeholder="Scan or enter barcode">
    <button onclick="addBarcode()">Add</button>
    <button id="scrapeBtn" onclick="startScraping()">Start Scraping</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Barcode</th>
          <th>Barserial</th>
          <th>Name</th>
          <th>Description</th>
          <th>Cost Price</th>
          <th>Retail Price</th>
          <th>Created At</th>
          <th>Quantity</th>
          <th>Bought in by</th>
            <th>Actions</th>
        </tr>
      </thead>
     <tbody id="barcodeTable">  </tbody>
    </table>
  </div>

  <div id="scrape-status"></div>
</div>



<script>

let counter = 1;
let barcodeQueue = [];  // used for scraping new items only
let productData = [];   // stores objects with barcode and barserial for ALL items
let isFirstScrape = true; // Track if this is the first scrape


function showEmptyRow() {
  const tbody = document.getElementById("barcodeTable");
  tbody.innerHTML = `
    <tr>
      <td colspan="12" style="text-align:center; color:#666; font-style:italic;">
        No barcodes added
      </td>
    </tr>
  `;
}

// Run on page load
document.addEventListener("DOMContentLoaded", showEmptyRow);

// Add barcode to queue and table
function addBarcode() {
  const input = document.getElementById("barcodeInput");
  const barcode = input.value.trim();
  if (!barcode) return;

  const tbody = document.getElementById("barcodeTable");

  // Check if this barcode already exists in the table
  const existingRow = document.querySelector(`tr[data-barcode="${barcode}"]`);
  if (existingRow) {
    alert("This barcode is already in the table.");
    input.value = '';
    input.focus();
    return;
  }

  // Remove "no barcodes" message if it exists
  if (tbody.children.length === 1 && tbody.children[0].textContent.includes("No barcodes")) {
    tbody.innerHTML = '';
  }

  const row = document.createElement("tr");
  row.dataset.barcode = barcode;
  row.innerHTML = `
      <td>${counter++}</td>
      <td>${barcode}</td>
      <td>-</td> <!-- Barserial -->
      <td>-</td> <!-- Name -->
      <td>-</td> <!-- Description -->
      <td>-</td> <!-- Cost Price -->
      <td>-</td> <!-- Retail Price -->
      <td>-</td> <!-- Created At -->
      <td>-</td> <!-- Quantity -->
      <td>-</td> <!-- Bought in by -->
      <td>
        <span class="remove-btn" onclick="removeRow(this, '${barcode}')">Remove</span>
        <span class="view-btn" style="margin-left:8px;" onclick="viewAnalysis('${barcode}')">Analyse</span>
      </td>
      </td>
    `;

  tbody.appendChild(row);

  input.value = '';
  input.focus();

  // After adding new items, change button back to "Scrape" if we already had scraped items
  const scrapeBtn = document.getElementById("scrapeBtn");
  if (!isFirstScrape) {
    scrapeBtn.textContent = "Scrape New Items";
    scrapeBtn.onclick = startScraping;
  }
}

// Update the removeRow function to also clean up productData and barcodeQueue
function removeRow(button, barcode) {
  const row = button.closest('tr');
  row.remove();

  // Remove from productData
  productData = productData.filter(p => p.barcode !== barcode);

  // Remove from barcodeQueue
  barcodeQueue = barcodeQueue.filter(b => b !== barcode);

  counter -= 1;

  // Update UI if table becomes empty
  const tbody = document.getElementById("barcodeTable");
  if (tbody.children.length === 0) {
    showEmptyRow();
    counter = 1;
    isFirstScrape = true;

    // Reset button
    const scrapeBtn = document.getElementById("scrapeBtn");
    scrapeBtn.textContent = "Start Scraping";
    scrapeBtn.onclick = startScraping;
  }
}

// TODO: This is repeated in base_item_analysis and very WET. Figure out a way to make it DRY. Local automation agent helper
async function callLocalAgent(endpoint, payload = {}) {
  const agentUrl = "http://127.0.0.1:8001"; // local FastAPI agent
  const fullUrl = `${agentUrl}${endpoint}`;
  try {
    const res = await fetch(fullUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error("Could not connect to local automation agent:", err);
    alert("âŒ Could NOT connect to local agent. Is it running?");
    return null;
  }
}


// Start scraping via local agent - ONLY for new/pending items
async function startScraping() {
  const tbody = document.getElementById("barcodeTable");
  const rows = tbody.querySelectorAll('tr');

  // Find barcodes that have empty Name cells (not scraped yet)
  const pendingBarcodes = [];
  rows.forEach(row => {
    if (row.cells.length >= 10) { // Make sure it's a valid data row
      const barcode = row.cells[1].textContent.trim();
      const nameCell = row.cells[3].textContent.trim();

      // If name is empty, this barcode hasn't been scraped yet
      if (barcode && nameCell === '-') {
        pendingBarcodes.push(barcode);
      }
    }
  });

  if (pendingBarcodes.length === 0) {
    alert("No new barcodes to scrape. All barcodes have already been processed.");
    return;
  }

  const statusDiv = document.getElementById("scrape-status");
  statusDiv.className = "";
  statusDiv.innerHTML = `Scraping ${pendingBarcodes.length} new item(s) locally <span class='spinner'></span>`;

  try {
    // ðŸ”¥ Use local FastAPI agent instead of Django
    const data = await callLocalAgent("/scrape-barcodes", { barcodes: pendingBarcodes });

    if (!data) {
      statusDiv.className = "error";
      statusDiv.textContent = "âŒ Could not reach local agent.";
      return;
    }

    if (data.success) {
      // Update existing rows with scraped data
      data.products.forEach(product => {
        const row = document.querySelector(`tr[data-barcode="${product.barcode}"]`);
        if (row) {
          row.cells[2].textContent = product.barserial || '';
          row.cells[3].textContent = product.name || '';
          row.cells[4].textContent = product.description || '';
          row.cells[5].textContent = product.cost_price || '';
          row.cells[6].textContent = product.retail_price || '';
          row.cells[7].textContent = product.created_at || '';
          row.cells[8].textContent = product.quantity || '';
          row.cells[9].textContent = product.bought_by || '';


          //  Add or update productData
        const productIndex = productData.findIndex(p => p.barcode === product.barcode);
        if (productIndex !== -1) {
          productData[productIndex] = { ...productData[productIndex], ...product, status: 'scraped' };
        } else {
          productData.push({ ...product, status: 'scraped' });
        }

        }
      });

      statusDiv.className = "success";
      statusDiv.textContent = `âœ… Local scraping completed for ${data.products.length} new barcode(s).`;

      // Update button based on whether we have any pending items left
      const scrapeBtn = document.getElementById("scrapeBtn");
      const hasPendingItems = Array.from(tbody.querySelectorAll('tr')).some(row => {
        if (row.cells.length >= 10) {
          return row.cells[3].textContent.trim() === ''; // Name cell empty
        }
        return false;
      });

    scrapeBtn.textContent = "Scrape New Items";
    scrapeBtn.onclick = startScraping;

      isFirstScrape = false;
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

    } else {
      statusDiv.className = "error";
      statusDiv.textContent = `âŒ Error: ${data.error || "Unknown error"}`;
    }

  } catch (err) {
    console.error("Scrape error:", err);
    statusDiv.className = "error";
    statusDiv.textContent = `âŒ Request failed: ${err.message}`;
  }
}

// helper to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function viewAnalysis(barcode) {
  const product = productData.find(p => p.barcode === barcode);
  if (!product) {
    alert("Item data not found. Please scrape this item first.");
    return;
  }

  // Build query params for the analyzer
  const params = new URLSearchParams({
    name: product.name || '',
    description: product.description || '',
    barserial: product.barserial || '',
    cost_price: product.cost_price || '',
    barcode: product.barcode || ''
  });

  // Assuming your analyzer view is named 'individual_item_analyser'
  const baseUrl = "{% url 'individual_item_analyser' %}";
  // Navigate to analyzer page
  window.open(`${baseUrl}?${params.toString()}`, '_blank'); // or use window.location.href to replace current page
}


</script>
</body>
</html>