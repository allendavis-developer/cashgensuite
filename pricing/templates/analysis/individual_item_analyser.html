{% extends "analysis/base_item_analysis.html" %}

{% block title %}Pricing Analysis{% endblock %}

{% block header_title %}PRICING ANALYSIS{% endblock %}

{% block panel_title %}INPUT PANEL{% endblock %}

{% block item_name %}
  <div class="input-row">
    <div class="input-group" style="flex: 2;">
      <label class="input-label">Item Name</label>
      <input
        type="text"
        id="item-name"
        class="input-field"
        value="{{ prefilled_data.name|default:'' }}"
        placeholder="iPhone 14"
        required
      >
    </div>
  </div>
{% endblock item_name %}

{% block description %}
  <div class="input-group">
    <label class="input-label">Description</label>
    <textarea
      id="description"
      class="input-field description-field"
      required>{{ prefilled_data.description|default:'' }}</textarea>
  </div>
{% endblock description %}


{% block after_description %}
  <div class="input-row">
    <div class="input-group" style="flex: 1;">
      <label class="input-label" for="cost-price">Cost Price (Â£)</label>
      <input
        type="number"
        id="cost-price"
        class="input-field"
        placeholder="Enter cost price"
        step="0.01"
        min="0"
        value="{{ prefilled_data.cost_price|default_if_none:'' }}"
        required
      >
    </div>

    <div class="input-group" style="flex: 1;">
      <label class="input-label" for="barserial">Bar/Serial Number</label>
      <input
        type="text"
        id="barserial"
        class="input-field"
        placeholder="e.g., SN1234567890"
        value="{{ prefilled_data.barserial|default_if_none:'' }}"
        required
      >
    </div>
  </div>

    <div class="input-group" style="margin-top: 16px;">
      <label class="input-label">Select Websites to Scrape</label>
      <div id="competitor-checkboxes" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 6px;">
        <label><input type="checkbox" name="competitors" value="CashConverters" checked> CashConverters</label>
        <label><input type="checkbox" name="competitors" value="CashGenerator" checked> CashGenerator</label>
        <label><input type="checkbox" name="competitors" value="CEX" checked> CEX</label>
        <label><input type="checkbox" name="competitors" value="eBay"> eBay</label>
      </div>
    </div>

{% endblock after_description %}


{% block analyze_button %}
    <button type="button" id="scrape-btn" class="analyze-button" onclick="scrapePrices()">
      <span id="button-text">SCRAPE PRICES</span>
      <span id="button-spinner" class="loading-spinner hidden"></span>
    </button>
    <button type="button" id="analyze-btn" class="analyze-button" onclick="analyzeTable()">
      <span id="button-text">ANALYZE RELEVANT CC AND CG LISTINGS</span>
      <span id="button-spinner" class="loading-spinner hidden"></span>
    </button>

    {% block analysis_actions %}
  <button id="confirm-list-btn" class="analyze-button" style="margin-bottom:20px;">
    CONFIRM & LIST
  </button>
{% endblock %}
  {% endblock analyze_button %}

{% block modals %}
<div id="list-modal" class="hidden" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
">
  <div style="
      background-color: #111;
      border: 1px solid #333;
      border-radius: 8px;
      width: 480px;
      max-width: 90%;
      padding: 20px;
      color: #fff;
      position: relative;
      display: flex;
      flex-direction: column;
  ">
    <span id="modal-close" style="
        position: absolute;
        top: 12px;
        right: 16px;
        cursor: pointer;
        font-size: 18px;
        color: #888;
    ">&times;</span>

    <h2 style="margin-bottom: 16px; font-size: 16px; text-transform: uppercase;">Confirm Listing</h2>

    <div style="margin-bottom: 12px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Item Name</label>
      <input id="modal-item-name" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <div style="margin-bottom: 12px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Description</label>
      <textarea id="modal-description" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          min-height: 80px;
          margin-top: 4px;
          resize: vertical;
          max-height: 400px;
      "></textarea>
    </div>

    <div style="margin-bottom: 16px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Serial Number</label>
      <input id="modal-serial-number" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <div style="margin-bottom: 12px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Select Price Source</label>
      <select id="price-source-select" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
          cursor: pointer;
      ">
        <option value="" selected disabled>-- Choose Source --</option>
        <option value="CashConverters">CashConverters Recommended Price</option>
        <option value="CashGenerator">CashGenerator Recommended Price</option>
      </select>
    </div>

    <div style="margin-bottom: 16px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Price</label>
      <input id="modal-price" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <button id="modal-submit" style="
        width: 100%;
        padding: 14px;
        background-color: #fff;
        color: #000;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-transform: uppercase;
    ">List Item</button>
  </div>
</div>
{% endblock %}

{% block analysis_section %}
<div class="analysis-section analysis-scroll-container" id="analysis-section" style="display: none;">
    <div class="analysis-header">
        <div class="analysis-status">{% block analysis_status %}âš¡ ANALYSIS COMPLETE{% endblock %}</div>
        <div class="analysis-time" id="analysis-time">{% block analysis_time %}just now{% endblock %}</div>
    </div>

    <!-- Flex container for recommended prices -->
    <div style="display: flex; flex-direction: column; gap: 0.2rem; margin-bottom: 0.5rem;">
        <div class="recommended-price">
            CC RECOMMENDED PRICE: <span id="recommended-price-cashconverters">-</span>
        </div>
        <div class="recommended-price">
            CG RECOMMENDED PRICE: <span id="recommended-price-cashgenerator">-</span>
        </div>
    </div>

    <div class="reasoning">
        <div class="reasoning-title">REASONING:</div>
        <div class="reasoning-text" id="reasoning-text">
            {% block reasoning_placeholder %}{% endblock %}
        </div>
    </div>
</div>

{% endblock %}


{% block extra_style %}
  /* Checkbox container styling */
  #competitor-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 6px;
  }

  /* Label wrapper */
  #competitor-checkboxes label {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #111;
    color: #fff;
    padding: 10px 14px;
    border: 1px solid #333;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-size: 13px;
    user-select: none;
  }

  /* Hover effect */
  #competitor-checkboxes label:hover {
    background-color: #1a1a1a;
    border-color: #555;
  }

  /* Checkbox input */
  #competitor-checkboxes input[type="checkbox"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #888;
    border-radius: 4px;
    background-color: #000;
    transition: all 0.2s ease-in-out;
    position: relative;
    cursor: pointer;
  }

  /* Checked state */
  #competitor-checkboxes input[type="checkbox"]:checked {
    background-color: #fff;
    border-color: #fff;
  }

  /* Custom checkmark */
  #competitor-checkboxes input[type="checkbox"]:checked::after {
    content: "âœ”";
    color: #000;
    position: absolute;
    font-size: 11px;
    top: 0;
    left: 2px;
  }

{% endblock %}

{% block extra_script %}
const modal = document.getElementById('list-modal');
const modalClose = document.getElementById('modal-close');
const modalItemName = document.getElementById('modal-item-name');
const modalDescription = document.getElementById('modal-description');
const modalPrice = document.getElementById('modal-price');
const confirmListBtn = document.getElementById('confirm-list-btn');
const modalSubmitBtn = document.getElementById('modal-submit');
const priceSourceSelect = document.getElementById('price-source-select');

modal.classList.add('hidden');
modal.style.display = 'none';

confirmListBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    modal.classList.remove('hidden');

    modalItemName.value = document.getElementById('item-name').value;
    modalDescription.value = document.getElementById('description').value;
{#    modalPrice.value = document.getElementById('recommended-price').textContent.replace(/[^0-9.]+/g, '');#}
    document.getElementById('modal-serial-number').value = document.getElementById('barserial').value;
});

modalClose.addEventListener('click', () => {
    modal.style.display = 'none';
    modal.classList.add('hidden');
});

window.addEventListener('click', (e) => {
    if (e.target === modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
});

priceSourceSelect.addEventListener('change', () => {
    const source = priceSourceSelect.value;
    let priceValue = "";

    if (source === "CashConverters") {
        priceValue = document.getElementById('recommended-price-cashconverters')?.textContent.trim() || "";
    } else if (source === "CashGenerator") {
        priceValue = document.getElementById('recommended-price-cashgenerator')?.textContent.trim() || "";
    }

    if (!priceValue || priceValue === "-") {
        alert("Please analyze prices before selecting a recommended price.");
        priceSourceSelect.value = "";
        modalPrice.value = "";
        return;
    }

    // Clean up the price string (remove Â£ if present)
    priceValue = priceValue.replace(/[^0-9.]/g, "");
    modalPrice.value = priceValue;
});


modalSubmitBtn.addEventListener('click', async function() {
    modalSubmitBtn.disabled = true;
    modalSubmitBtn.textContent = 'Launching Automation...';

      await launchPlaywrightListing(modalItemName.value, modalDescription.value, modalPrice.value, document.getElementById('modal-serial-number').value);

});


// -------------------------------
// ðŸ§± SCRAPING PHASE
// -------------------------------
async function scrapePrices() {
    const itemName = document.getElementById('item-name').value.trim();
    if (!itemName) {
        alert('Please enter an item name first.');
        return;
    }

    const scrapeBtn = document.getElementById('scrape-btn');
    scrapeBtn.disabled = true;
    scrapeBtn.textContent = 'Scraping...';

    const selectedCompetitors = Array.from(document.querySelectorAll('input[name="competitors"]:checked'))
    .map(cb => cb.value);

    if (selectedCompetitors.length === 0) {
        alert('Please select at least one website to scrape.');
        scrapeBtn.disabled = false;
        scrapeBtn.textContent = 'Scrape Prices';
        return;
    }


    try {
        const response = await callLocalAgent("/scrape-prices", {
            query: itemName,
            competitors: selectedCompetitors,
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Convert object array to the string format your updateCompetitorData expects
                const formattedData = data.results.map(item => {
                    // competitor | title | price | store | url
                    return `${item.competitor} | ${item.title || ""} | Â£${item.price} | ${item.store || ""} | ${item.url || ""}`;
                });

                console.log(data)
                updateCompetitorData(formattedData, formattedData.length);
            } else {
                alert("Scraping failed: " + data.error);
            }
        } else {
            alert("Local scraper unavailable or returned an error.");
        }

    } catch (error) {
        console.error('Scraping error:', error);
        alert('Error running scraper. Check local agent connection.');
    } finally {
        scrapeBtn.disabled = false;
        scrapeBtn.textContent = 'Scrape Prices';
    }
}


// -------------------------------
// ðŸ§© ANALYSIS PHASE (Two-step: CashConverters â†’ CashGenerator)
// -------------------------------
async function analyzeTable() {
    const itemName = document.getElementById('item-name').value.trim();
    const description = document.getElementById('description').value.trim();
    const urgency = parseInt(document.getElementById('urgency').value);

    if (!itemName || !description) {
        alert("Please fill in the item name and description.");
        return;
    }

    let competitorData = extractCompetitorTableData();
    if (!competitorData || competitorData.length === 0) {
        alert("No competitor data found. Please scrape and mark relevant rows first.");
        return;
    }
    // Filter sets
    const cashConvertersData = competitorData.filter(
        item => item.competitor.toLowerCase() === 'cashconverters'
    );
    const cashGeneratorData = competitorData.filter(
        item => item.competitor.toLowerCase() === 'cashgenerator'
    );

    console.log(cashConvertersData);
    console.log(cashGeneratorData);

    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'Analyzing CashConverters...';

    // Run first analysis (CashConverters only)
    try {
        if (cashConvertersData.length > 0) {
            const response1 = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    item_name: itemName,
                    description: description,
                    competitor_data: cashConvertersData,
                    cost_price: document.getElementById('cost-price').value,
                    urgency: urgency
                })
            });
            const data1 = await response1.json();

            if (data1.success) {
                displayDualAnalysis(data1.reasoning, data1.suggested_price, 'CashConverters');
            } else {
                alert(`CashConverters analysis failed: ${data1.error}`);
            }
        } else {
            console.warn("No CashConverters data found.");
        }

        // Run second analysis (CashGenerator only)
        analyzeBtn.textContent = 'Analyzing CashGenerator...';
        if (cashGeneratorData.length > 0) {
            const response2 = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    item_name: itemName,
                    description: description,
                    competitor_data: cashGeneratorData,
                    cost_price: document.getElementById('cost-price').value,
                    urgency: urgency
                })
            });
            const data2 = await response2.json();

            if (data2.success) {
                displayDualAnalysis(data2.reasoning, data2.suggested_price, 'CashGenerator');
            } else {
                alert(`CashGenerator analysis failed: ${data2.error}`);
            }
        } else {
            console.warn("No CashGenerator data found.");
        }

    } catch (error) {
        console.error('Analysis error:', error);
        alert('Network error. Please try again.');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Analyze Relevant CC and CG listings';
    }
}

async function launchPlaywrightListing(itemName, description, price, serialNumber) {
  const data = await callLocalAgent("/launch-playwright-listing", {
      item_name: itemName,
      description,
      price,
      serial_number: serialNumber,
  });

  if (!data) return alert("Automation agent not running.");

  if (data.success) {
      alert("âœ… Listing automation completed successfully!");
  } else {
      alert(`âŒ Automation failed: ${data.error}`);
  }
}


// ðŸ§¾ Extract table data for analysis
function extractCompetitorTableData() {
    const rows = allCompetitorRows;
    return Array.from(rows)
        .filter(row => row.getAttribute('data-relevant') === 'Yes') // only relevant
        .map(row => {
            const cells = row.querySelectorAll('td');
            return {
                competitor: cells[0]?.textContent.trim() || '',
                price: parseFloat(cells[2]?.textContent.replace(/[^0-9.]/g, '')) || 0,
                condition: cells[1]?.textContent.trim() || '',
                link: cells[3]?.querySelector('a')?.href || ''
            };
        }).filter(item => item.competitor);
}

// Remove irrelevant competitor rows
function removeIrrelevantCompetitors() {
    const rows = document.querySelectorAll('#competitor-table tbody tr');
    rows.forEach(row => {
        if (row.getAttribute('data-relevant') === 'No') {
            row.remove();
        }
    });
}

function displayDualAnalysis(reasoning, suggestedPrice, source) {
    const analysisSection = document.getElementById('analysis-section');
    const reasoningText = document.getElementById('reasoning-text');
    const analysisTime = document.getElementById('analysis-time');

    // Update the recommended price for the correct source
    if (source === 'CashConverters') {
        document.getElementById('recommended-price-cashconverters').textContent = suggestedPrice;
    } else if (source === 'CashGenerator') {
        document.getElementById('recommended-price-cashgenerator').textContent = suggestedPrice;
    }

    // Append reasoning instead of replacing
    reasoningText.innerHTML += `<div style="margin-top: 1rem;"><strong>[${source}]</strong><br>${reasoning}</div>`;

    // Show analysis section
    analysisSection.style.display = 'block';
    analysisSection.scrollIntoView({ behavior: 'smooth' });

    // Update analysis timestamp
    analysisTime.textContent = 'just now';
}


document.addEventListener('DOMContentLoaded', function() {
    // Existing prefilled item/description logic
    const prefilledItem = "{{ prefilled_item|escapejs }}";
    const prefilledDescription = "{{ prefilled_description|escapejs }}";

    if (prefilledItem && prefilledDescription) {
        document.getElementById('item-name').value = prefilledItem;
        document.getElementById('description').value = prefilledDescription;
    }

    const costInput = document.getElementById('cost-price');
    if (costInput && costInput.value) {
        setRRPAfterTable(costInput.value);
    }
});

{% endblock %}