{% extends "analysis/base_item_analysis.html" %}

{% block title %}Pricing Analysis{% endblock %}

{% block header_title %}PRICING ANALYSIS{% endblock %}

{% block panel_title %}INPUT PANEL{% endblock %}

{% block input_panel_content %}
{% csrf_token %}
<div class="input-row">
  <div class="input-group" style="flex: 2;">
    <label class="input-label">Item Name</label>
    <input type="text" id="item-name" class="input-field" placeholder="iPhone 14" required>
  </div>
</div>

<div class="input-group">
  <label class="input-label">Description</label>
  <textarea id="description" class="input-field description-field" placeholder="Good condition, minor scratches, original box included..." required></textarea>
</div>

<div class="input-group">
  <label class="input-label">Serial Number</label>
  <input type="text" id="serial-number" class="input-field" placeholder="Enter serial number">
</div>

<button type="button" id="analyze-btn" class="analyze-button" onclick="analyzeItem()">
  <span id="button-text">ANALYZE PRICING</span>
  <span id="button-spinner" class="loading-spinner hidden"></span>
</button>
{% endblock %}

{% block analysis_actions %}
<button id="confirm-list-btn" class="analyze-button" style="margin-bottom:20px;">
  CONFIRM & LIST
</button>
{% endblock %}

{% block modals %}
<div id="list-modal" class="hidden" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
">
  <div style="
      background-color: #111;
      border: 1px solid #333;
      border-radius: 8px;
      width: 480px;
      max-width: 90%;
      padding: 20px;
      color: #fff;
      position: relative;
      display: flex;
      flex-direction: column;
  ">
    <span id="modal-close" style="
        position: absolute;
        top: 12px;
        right: 16px;
        cursor: pointer;
        font-size: 18px;
        color: #888;
    ">&times;</span>

    <h2 style="margin-bottom: 16px; font-size: 16px; text-transform: uppercase;">Confirm Listing</h2>

    <div style="margin-bottom: 12px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Item Name</label>
      <input id="modal-item-name" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <div style="margin-bottom: 12px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Description</label>
      <textarea id="modal-description" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          min-height: 80px;
          margin-top: 4px;
          resize: vertical;
          max-height: 400px;
      "></textarea>
    </div>

    <div style="margin-bottom: 16px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Serial Number</label>
      <input id="modal-serial-number" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <div style="margin-bottom: 16px;">
      <label style="font-size: 11px; color: #888; text-transform: uppercase;">Price</label>
      <input id="modal-price" type="text" style="
          width: 100%;
          padding: 10px;
          background-color: #1a1a1a;
          border: 1px solid #333;
          color: #fff;
          border-radius: 4px;
          margin-top: 4px;
      ">
    </div>

    <button id="modal-submit" style="
        width: 100%;
        padding: 14px;
        background-color: #fff;
        color: #000;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-transform: uppercase;
    ">List Item</button>
  </div>
</div>
{% endblock %}

{% block extra_script %}
const modal = document.getElementById('list-modal');
const modalClose = document.getElementById('modal-close');
const modalItemName = document.getElementById('modal-item-name');
const modalDescription = document.getElementById('modal-description');
const modalPrice = document.getElementById('modal-price');
const confirmListBtn = document.getElementById('confirm-list-btn');
const modalSubmitBtn = document.getElementById('modal-submit');

modal.classList.add('hidden');
modal.style.display = 'none';

confirmListBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    modal.classList.remove('hidden');

    modalItemName.value = document.getElementById('item-name').value;
    modalDescription.value = document.getElementById('description').value;
    modalPrice.value = document.getElementById('recommended-price').textContent.replace(/[^0-9.]+/g, '');
    document.getElementById('modal-serial-number').value = document.getElementById('serial-number').value;
});

modalClose.addEventListener('click', () => {
    modal.style.display = 'none';
    modal.classList.add('hidden');
});

window.addEventListener('click', (e) => {
    if (e.target === modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
});

modalSubmitBtn.addEventListener('click', async function() {
    modalSubmitBtn.disabled = true;
    modalSubmitBtn.textContent = 'Launching Automation...';

    try {
        const response = await fetch('/launch-playwright-listing/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_name: modalItemName.value,
                description: modalDescription.value,
                price: modalPrice.value,
                serial_number: document.getElementById('modal-serial-number').value
            })
        });

        const result = await response.json();

        if (result.success) {
            setTimeout(() => {
                modalSubmitBtn.textContent = '✅ Automation Complete!';
                modalSubmitBtn.disabled = false;
            }, 2000);
        } else {
            alert(`Automation failed: ${result.error}`);
            modalSubmitBtn.disabled = false;
            modalSubmitBtn.textContent = 'List Item';
        }
    } catch (error) {
        console.error('Error launching automation:', error);
        alert('Failed to launch automation. Please try again.');
        modalSubmitBtn.disabled = false;
        modalSubmitBtn.textContent = 'List Item';
    }
});

function displayAnalysis(reasoning, suggestedPrice) {
    const analysisSection = document.getElementById('analysis-section');
    const recommendedPrice = document.getElementById('recommended-price');
    const reasoningText = document.getElementById('reasoning-text');
    const analysisTime = document.getElementById('analysis-time');

    recommendedPrice.textContent = suggestedPrice;
    reasoningText.innerHTML = reasoning;

    const competitorCount = parseInt(document.getElementById('competitor-number').textContent);

    analysisTime.textContent = 'just now';

    analysisSection.style.display = 'block';
    analysisSection.scrollIntoView({ behavior: 'smooth' });
}

async function analyzeItem() {
    const itemName = document.getElementById('item-name').value.trim();
    const description = document.getElementById('description').value.trim();
    const analyzeBtn = document.getElementById('analyze-btn');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');

    if (!itemName || !description) {
        return;
    }

    analyzeBtn.disabled = true;
    buttonText.classList.add('hidden');
    buttonSpinner.classList.remove('hidden');

    try {
        // Step 1️⃣ — try local scraper
        let localResults = null;
        try {
            const scrapeResponse = await callLocalAgent("/scrape-prices", {
                query: itemName,
                competitors: ["CashConverters", "CashGenerator", "CEX", "eBay"],
            });

            if (scrapeResponse.ok) {
                const scrapeData = await scrapeResponse.json();
                if (scrapeData.success) {
                    console.log("✅ Local scraper results:", scrapeData.results);
                    localResults = scrapeData.results;
                } else {
                    console.warn("Local scraper error:", scrapeData.error);
                }
            } else {
                console.warn("Local scraper unreachable or returned error");
            }

        } catch (scrapeErr) {
            console.warn("Local scraper not running:", scrapeErr);
        }

        // Step 2️⃣ — post to Django with or without local results
        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_name: itemName,
                description: description,
                local_scrape_data: localResults // optional
            })
        });

        const data = await response.json();

        if (data.success) {
            updateCompetitorData(data.competitor_data || '', data.competitor_count || 0);
            displayAnalysis(data.reasoning, data.suggested_price);
        } else {
            alert(`Error: ${data.error}`);
        }

    } catch (error) {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    } finally {
        analyzeBtn.disabled = false;
        buttonText.classList.remove('hidden');
        buttonSpinner.classList.add('hidden');
    }
}


document.getElementById('description').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        analyzeItem();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const prefilledItem = "{{ prefilled_item|escapejs }}";
    const prefilledMarketItem = "{{ prefilled_market_item|escapejs }}";
    const prefilledDescription = "{{ prefilled_description|escapejs }}";
    const prefilledSerial = "{{ prefilled_serial|escapejs }}";

    if (prefilledItem) {
        document.getElementById('item-name').value = prefilledItem;
    } else if (prefilledMarketItem) {
        document.getElementById('item-name').value = prefilledMarketItem;
    }

    if (prefilledSerial) {
        document.getElementById('serial-number').value = prefilledSerial;
    }

    if (prefilledDescription) {
        document.getElementById('description').value = prefilledDescription;
    }

    if ((prefilledItem || prefilledMarketItem) && prefilledDescription) {
        setTimeout(() => {
            analyzeItem();
        }, 500);
    }
});
{% endblock %}