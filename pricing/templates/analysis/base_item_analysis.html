<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Pricing Analysis{% endblock %}</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  a { color: #ffffff !important; text-decoration: underline; }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    font-size: 16px;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: #000000;
    color: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-size: 0.875rem;
    overflow: hidden;
  }

  .header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #333333;
    background-color: #111111;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .header h1 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #ffffff;
    letter-spacing: 0.03em;
  }

  .main-content {
    flex: 1;
    display: flex;
    min-height: 0;
    overflow: hidden;
  }

  .input-panel {
    width: clamp(320px, 25vw, 400px);
    border-right: 1px solid #333333;
    background-color: #111111;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .competitor-panel {
    flex: 1;
    background-color: #0a0a0a;
    padding: 1.25rem;
    overflow-y: auto;
    min-width: 0;
  }

  .panel-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #888888;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .input-group {
    margin-bottom: 1rem;
  }

  .input-label {
    display: block;
    font-size: 0.6875rem;
    color: #888888;
    margin-bottom: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .input-field {
    width: 100%;
    padding: 0.75rem;
    background-color: #1a1a1a;
    border: 1px solid #333333;
    color: #ffffff;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    border-radius: 0.25rem;
  }

  .input-field:focus {
    outline: none;
    border-color: #555555;
    background-color: #222222;
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
  }

  .description-field {
    min-height: 6.25rem;
    resize: vertical;
  }

  .analyze-button {
    padding: 1rem 1.5rem;
    background-color: #ffffff;
    color: #000000;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-top: 1.25rem;
    border-radius: 0.25rem;
    width: 100%;
  }

  .analyze-button:hover:not(:disabled) {
    background-color: #e6e6e6;
  }

  .analyze-button:disabled {
    background-color: #333333;
    color: #666666;
    cursor: not-allowed;
  }

  .competitor-count {
    font-size: 0.75rem;
    color: #666666;
    margin-bottom: 1rem;
  }

  .competitor-table {
    border: 1px solid #333333;
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.25rem;
    font-size: 0.8125rem;
  }

  .competitor-table th,
  .competitor-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #333333;
  }

  .competitor-table th {
    background-color: #1a1a1a;
    color: #888888;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.6875rem;
    white-space: nowrap;
  }

  .competitor-table td {
    word-wrap: break-word;
    max-width: 0;
  }

  .competitor-table td:nth-child(2) {
    max-width: 300px;
  }

  .market-stats {
    background-color: #111111;
    padding: 1rem;
    border: 1px solid #333333;
    margin-bottom: 1.25rem;
    border-radius: 0.25rem;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.8125rem;
  }

  .stat-label {
    color: #888888;
    text-transform: uppercase;
    font-size: 0.6875rem;
  }

  .stat-value {
    color: #ffffff;
    font-weight: 600;
  }

  .warning {
    background-color: #1a1100;
    border: 1px solid #444400;
    padding: 0.75rem;
    margin-bottom: 1.25rem;
    color: #ffff88;
    font-size: 0.75rem;
    border-radius: 0.25rem;
  }

  .analysis-section {
    background-color: #111111;
    border-top: 1px solid #333333;
    padding: 1.25rem;
    max-height: 30vh;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .analysis-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .analysis-status {
    font-size: 0.75rem;
    color: #00ff00;
    font-weight: 600;
    text-transform: uppercase;
  }

  .analysis-time {
    font-size: 0.6875rem;
    color: #666666;
  }

  .recommended-price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 1.25rem;
  }

  .reasoning {
    margin-bottom: 1.25rem;
  }

  .reasoning-title {
    font-size: 0.75rem;
    color: #888888;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .reasoning-text {
    font-size: 1rem;
    line-height: 1.6;
    color: #cccccc;
  }

  .controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .controls label {
    font-size: 0.6875rem;
    font-weight: 600;
    color: #888888;
    text-transform: uppercase;
    margin-right: 0.25rem;
  }

  .controls select {
    padding: 0.375rem 0.625rem;
    background-color: #1a1a1a;
    border: 1px solid #333333;
    border-radius: 0.25rem;
    color: #ffffff;
    font-size: 0.75rem;
    cursor: pointer;
    min-width: 8.75rem;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .controls select:focus {
    outline: none;
    border-color: #555555;
    background-color: #222222;
  }

  .loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #333333;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .hidden {
    display: none;
  }

  .header .menu-card {
    padding: 0.375rem 0.75rem;
    background: #444;
    color: #fff;
    border-radius: 0.25rem;
    text-decoration: none;
    font-size: 0.75rem;
    white-space: nowrap;
  }

  .header-right {
    font-size: 0.6875rem;
    color: #666666;
    white-space: nowrap;
  }
.competitor-table th:nth-child(5),
.competitor-table td:nth-child(5) {
  width: 60px;       /* narrow column width */
  text-align: center; /* visually centered */
  white-space: nowrap;
}

  .price-highlight {
    color: #00e0ff; /* cyan for averages */
  }

  .price-range {
    color: #ffaa00; /* amber for ranges */
  }

  .source-highlight {
    color: #666666;
  }


/* === SCALE FIX === */
    html {
      font-size: 14px; /* down from 16px ‚Äî ~87.5% scaling */
    }

    body {
        min-height: 100vh;
        overflow-y: auto; /* allow normal scrolling */
    }

    .input-panel, .competitor-panel, .analysis-section {
      padding: 1.5rem;
    }

    .input-field,
    textarea,
    select {
      font-size: 0.8125rem;
    }

    .header h1 {
      font-size: 1rem;
    }

    /* === Scrollable Analysis Container === */
  .resize-handle {
    height: 16px;
    background-color: #1a1a1a;
    border: 1px solid #333;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    cursor: ns-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }

  .resize-handle:hover {
    background-color: #222;
  }

  .resize-handle:active {
    background-color: #2a2a2a;
  }

  .resize-grip {
    width: 40px;
    height: 4px;
    background-color: #444;
    border-radius: 2px;
    position: relative;
  }

  .resize-grip::before,
  .resize-grip::after {
    content: '';
    position: absolute;
    width: 40px;
    height: 4px;
    background-color: #444;
    border-radius: 2px;
  }

  .resize-grip::before { top: -6px; }
  .resize-grip::after { top: 6px; }

  .analysis-scroll-container {
    height: 30vh;
    min-height: 200px;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid #333;
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 20px;
    background-color: #0a0a0a;
  }

  .relevance-select {
    background-color: transparent;
    border: 1px solid #333333;
    color: #ffffff;
    font-family: 'Inter', sans-serif;
    font-size: 0.8125rem;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    border-radius: 0.25rem;
    width: 100%;
  }

  .relevance-select:focus {
    outline: none;
    border-color: #555555;
    background-color: #1a1a1a;
  }

  .relevance-select option {
    background-color: #1a1a1a;
    color: #ffffff;
  }

  /* Visual feedback for relevance state */
  tr[data-relevant="No"] {
    opacity: 0.3;
  }

  tr[data-relevant="Yes"] {
    opacity: 1;
  }

  /* WebKit browsers (Chrome, Safari, Edge) */
    ::-webkit-scrollbar {
      width: 10px;               /* Width of vertical scrollbar */
      height: 10px;              /* Height of horizontal scrollbar */
    }

    ::-webkit-scrollbar-track {
      background: #111111;       /* Track background */
      border-radius: 8px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #444;    /* Scroll thumb */
      border-radius: 8px;
      border: 2px solid #111111; /* Padding around thumb */
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #666;    /* Hover effect */
    }

    /* Firefox */
    * {
      scrollbar-width: thin;      /* "auto" or "thin" */
      scrollbar-color: #444 #111; /* thumb color, track color */
    }

    .highlight-undercut {
  background-color: #141414 !important;
  border-left: 3px solid #00e0ff;
}


  {% block extra_style %}{% endblock %}
</style>
</head>
<body>

<div class="header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
  {% block back_button %}
  <a href="{% url 'home' %}" class="menu-card" style="
      padding:6px 12px;
      background:#444;
      color:#fff;
      border-radius:4px;
      text-decoration:none;
      font-size:12px;
  ">BACK TO HOME PAGE</a>
  {% endblock %}


  <h1>{% block header_title %}PRICING ANALYSIS{% endblock %}</h1>
  <div style="font-size: 11px; color: #666666;">CASH GENERATOR SYSTEM</div>
</div>

<div class="main-content">
  <div class="input-panel">
    <div class="panel-title">{% block panel_title %}INPUT PANEL{% endblock %}</div>
    {% block input_panel_content %}
      {% block item_name %}
        <div class="input-row">
          <div class="input-group" style="flex: 2;">
            <label class="input-label">Search Term</label>
            <input type="text" id="item-name" class="input-field" placeholder="iPhone 14" required>
          </div>
        </div>
      {% endblock item_name %}

      {% block description %}
        <div class="input-group">
          <label class="input-label">Description</label>
          <textarea id="description" class="input-field description-field" placeholder="Good condition, minor scratches, original box included..." required></textarea>
        </div>
      {% endblock description %}

      {% block after_description %}{% endblock after_description %}

      {% block urgency %}
        <div class="input-group">
          <label class="input-label" for="urgency">Sale Urgency</label>
          <select id="urgency" class="input-field" style="cursor: pointer;">
            <option value="1">1 - No Rush (Max Profit)</option>
            <option value="2">2 - Standard Timeline</option>
            <option value="3" selected>3 - Moderate Urgency</option>
            <option value="4">4 - High Urgency</option>
            <option value="5">5 - Must Sell ASAP</option>
          </select>
        </div>
      {% endblock urgency %}

  {% block margin %}
    <div class="input-group">
      <label class="input-label">Minimum Margin (%)</label>
      <input type="number" id="minimum-margin" class="input-field" placeholder="37.5" value="37.5" step="0.1" min="0" max="100">
    </div>
  {% endblock margin %}

  {% block analyze_button %}
    <button type="button" id="analyze-btn" class="analyze-button" onclick="analyzeItem()">
      <span id="button-text">ANALYZE PRICING</span>
      <span id="button-spinner" class="loading-spinner hidden"></span>
    </button>

{% block analysis_actions %}{% endblock %}

  {% endblock analyze_button %}
{% endblock input_panel_content %}

  </div>

  <div class="competitor-panel">

        <div class="panel-title" style="margin-top: 1.5rem; font-size: 0.75rem; text-transform: uppercase; color: #888;">MARKET SUMMARY</div>

    <table class="competitor-table" id="analysis-table">
      <thead>
        <tr>
          <th>CEX Price Avg</th>
          <th>CEX - Discount % (20% for now)</th>
          <th>Cost Price + Your Minimum Margin</th>
          <th>Cash Converters Lowest</th>
          <th>Cash Converters Avg</th>
          <th>Cash Generator Lowest</th>
          <th>Cash Generator Avg</th>
        </tr>
      </thead>
      <tbody id="analysis-tbody">
        <tr>
          <td colspan="5" style="text-align: center; color: #666; font-style: italic;">
            No market summary data available
          </td>
        </tr>
      </tbody>
    </table>



    <div class="controls">
      <label for="sort-price">Sort by:</label>
      <select id="sort-price">
        <option value="none">None</option>
        <option value="asc">Lowest ‚Üí Highest</option>
        <option value="desc">Highest ‚Üí Lowest</option>
      </select>

      <label for="filter-source">Filter by:</label>
      <select id="filter-source">
        <option value="all">All Sources</option>
        <option value="CashConverters">CashConverters</option>
        <option value="CashGenerator" selected>CashGenerator</option>
        <option value="CeX">CeX</option>
        <option value="eBay">eBay</option>
      </select>
    </div>

    <div class="competitor-count" id="competitor-count">
      SOURCES FOUND: <span id="competitor-number">0</span>
    </div>

    <table class="competitor-table" id="competitor-table">
      <thead>
        <tr>
          <th>SOURCE</th>
          <th>ITEM</th>
          <th>PRICE</th>
          <th>STORE</th>
          <th>UNDERCUT</th>
          <th>RELEVANT?</th>
        </tr>
      </thead>
      <tbody id="competitor-tbody">
        <tr>
          <td colspan="4" style="text-align: center; color: #666666; font-style: italic;">
            {% block competitor_empty_state %}No competitor data available{% endblock %}
          </td>
        </tr>
      </tbody>
    </table>

    <div class="market-stats" id="market-stats" style="display: none;">
      <div class="stat-row">
        <span class="stat-label">MARKET RANGE:</span>
        <span class="stat-value" id="price-range">-</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">AVERAGE:</span>
        <span class="stat-value" id="price-average">-</span>
      </div>
    </div>

    <div class="warning" id="data-warning" style="display: none;">
      ‚ö† LIMITED DATA<br>
      Only <span id="warning-count">0</span> competitors found. Consider additional research.
    </div>
  </div>
</div>

<!-- === Resize Handle === -->
<div class="resize-handle">
  <div class="resize-grip"></div>
</div>


{% block analysis_section %}
<div class="analysis-section analysis-scroll-container" id="analysis-section" style="display: none;">
    <div class="analysis-header">
        <div class="analysis-status">{% block analysis_status %}‚ö° ANALYSIS COMPLETE{% endblock %}</div>
        <div class="analysis-time" id="analysis-time">{% block analysis_time %}just now{% endblock %}</div>
    </div>

    <!-- Flex container for recommended price + source averages -->
    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <div class="recommended-price" style="margin-bottom: 0;">
            RECOMMENDED PRICE: <span id="recommended-price">-</span>
        </div>


    </div>


    <div class="reasoning">
    <div class="reasoning-title">REASONING:</div>
    <div class="reasoning-text" id="reasoning-text">
      {% block reasoning_placeholder %}Analysis will appear here...{% endblock %}
    </div>
  </div>


{% endblock %}



</div>
  {% block buying_price_panel %}{% endblock %}

{% block modals %}{% endblock %}

<script>
// Shared utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function callLocalAgent(endpoint, payload = {}) {
    const agentUrl = "http://127.0.0.1:8001"; // local FastAPI agent
    const fullUrl = `${agentUrl}${endpoint}`;
    try {
      const res = await fetch(fullUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      return res; // <-- Return the actual Response object for consistency
    } catch (err) {
      console.error("Could not connect to local automation agent:", err);
      alert("Could NOT connect to local agent, are you sure it's running?");
      return null;
    }
}


let allCompetitorRows = [];
let currentCostPrice = null; // ‚úÖ Store cost price globally

function updateCompetitorData(competitorData, competitorCount) {
    const tbody = document.getElementById('competitor-tbody');
    const competitorNumber = document.getElementById('competitor-number');
    const marketStats = document.getElementById('market-stats');
    const dataWarning = document.getElementById('data-warning');
    const warningCount = document.getElementById('warning-count');

    competitorNumber.textContent = competitorCount;
    allCompetitorRows = [];

    if (competitorCount === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666666; font-style: italic;">No competitor data available</td></tr>';
        marketStats.style.display = 'none';
        dataWarning.style.display = 'none';
        return;
    }

    const lines = typeof competitorData === 'string' ? competitorData.trim().split('\n').filter(line => line.trim()) : competitorData;
    const prices = [];
    tbody.innerHTML = '';

    lines.forEach(line => {
        const parts = typeof line === 'string' ? line.split(' | ') : line;
        if (parts.length >= 5) {
            const competitor = typeof line === 'string' ? parts[0] : line.split(' | ')[0];
            const listingTitle = typeof line === 'string' ? parts[1] : line.split(' | ')[1];
            const price = typeof line === 'string' ? parts[2] : line.split(' | ')[2];
            const storeName = typeof line === 'string' ? parts[3] : line.split(' | ')[3];
            const url = typeof line === 'string' ? parts[4] : line.split(' | ')[4];

            const numericPrice = parseFloat(price.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(numericPrice)) prices.push(numericPrice);

            const row = document.createElement('tr');
            row.setAttribute('data-relevant', 'No');

            // Create select dropdown for relevance
            const selectHTML = `
                <select class="relevance-select" onchange="handleRelevanceChange(this)">
                    <option value="Yes">Yes</option>
                    <option value="No" selected>No</option>
                </select>
            `;

            row.innerHTML = `
                <td>${competitor}</td>
                <td><a href="${url}" target="_blank" rel="noopener noreferrer">${listingTitle}</a></td>
                <td>${price}</td>
                <td>${storeName}</td>
                <td class="undercut-cell">
                    <input type="checkbox" class="undercut-checkbox" onchange="handleUndercutSelect(this)">
                </td>
                <td data-text-value="No">${selectHTML}</td>
            `;
            allCompetitorRows.push(row);
        }
    });

    if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

        document.getElementById('price-range').textContent = `¬£${minPrice} - ¬£${maxPrice}`;
        document.getElementById('price-average').textContent = `¬£${avgPrice.toFixed(0)}`;
        marketStats.style.display = 'block';

        if (competitorCount <= 2) {
            warningCount.textContent = competitorCount;
            dataWarning.style.display = 'block';
        } else {
            dataWarning.style.display = 'none';
        }
    }

    const itemName = document.getElementById('item-name');
    applySortAndFilter();

    if (competitorCount > 0) {
        checkIrrelevantCompetitors(itemName);
    }
}

function handleUndercutSelect(checkbox) {
    const row = checkbox.closest('tr');
    const source = row.cells[0].textContent.trim().toUpperCase();

    // Get all checkboxes with the same source
    const allCheckboxes = document.querySelectorAll('.undercut-checkbox');
    const sameSourceCheckboxes = Array.from(allCheckboxes).filter(cb => {
        const r = cb.closest('tr');
        if (!r) return false;
        return r.cells[0].textContent.trim().toUpperCase() === source;
    });

    // If this checkbox was just checked, uncheck others in the same source group
    if (checkbox.checked) {
        sameSourceCheckboxes.forEach(cb => {
            if (cb !== checkbox) cb.checked = false;
        });

        //  AUTO-MARK AS RELEVANT
        const relevanceSelect = row.cells[5]?.querySelector('.relevance-select');
        if (relevanceSelect) {
            relevanceSelect.value = 'Yes';
            handleRelevanceChange(relevanceSelect); // Trigger the change handler
        }
    }

    // Optional: highlight selected undercut rows per source
    document.querySelectorAll('#competitor-tbody tr').forEach(r => {
        const cb = r.querySelector('.undercut-checkbox');
        if (!cb) return;
        const rowSource = r.cells[0].textContent.trim().toUpperCase();
        if (rowSource === source && cb.checked) {
            r.classList.add('highlight-undercut');
        } else if (rowSource === source && !cb.checked) {
            r.classList.remove('highlight-undercut');
        }
    });
}



// Handle dropdown changes
function handleRelevanceChange(selectElement) {
    const row = selectElement.closest('tr');
    const cell = selectElement.closest('td');
    const newValue = selectElement.value;

    // Update data attribute for backward compatibility
    cell.setAttribute('data-text-value', newValue);
    row.setAttribute('data-relevant', newValue);

    // Update opacity
    row.style.opacity = newValue === "Yes" ? "1" : "0.5";

    if (newValue === "No") {
        const checkbox = row.querySelector('.undercut-checkbox');
        if (checkbox && checkbox.checked) {
            checkbox.checked = false;
            handleUndercutSelect(checkbox); // reuse existing logic for highlight removal
        }
    }

    // Recompute averages
    computeSourceAverages();
}

function displayAnalysis(reasoning, suggestedPrice, append = false) {
    const analysisSection = document.getElementById('analysis-section');
    const recommendedPrice = document.getElementById('recommended-price');
    const reasoningText = document.getElementById('reasoning-text');
    const analysisTime = document.getElementById('analysis-time');

    if (append) {
        // Append reasoning text instead of replacing
        reasoningText.innerHTML += `<br><br>${reasoning}`;
    } else {
        reasoningText.innerHTML = reasoning;
    }

    // If appending, keep the previous recommended price but optionally update to latest
    recommendedPrice.textContent = suggestedPrice;

    const competitorCount = parseInt(document.getElementById('competitor-number').textContent);

    analysisTime.textContent = 'just now';
    analysisSection.style.display = 'block';
    analysisSection.scrollIntoView({ behavior: 'smooth' });
}


function applySortAndFilter() {
    const tbody = document.getElementById('competitor-tbody');
    let rows = [...allCompetitorRows];

    const sortValue = document.getElementById('sort-price').value;
    const filterValue = document.getElementById('filter-source').value.toLowerCase();

    // 1Ô∏è‚É£ Filtering
    rows = rows.filter(row => {
        if (row.cells[0].colSpan === 4) return false;
        const source = row.cells[0].textContent.trim().toLowerCase();
        return filterValue === 'all' || source === filterValue;
    });

    // 2Ô∏è‚É£ Sorting
    if (sortValue !== 'none') {
        // price sort
        rows.sort((a, b) => {
            const priceA = parseFloat(a.cells[2].textContent.replace(/[^0-9.-]+/g, "")) || 0;
            const priceB = parseFloat(b.cells[2].textContent.replace(/[^0-9.-]+/g, "")) || 0;
            return sortValue === 'asc' ? priceA - priceB : priceB - priceA;
        });
    } else if (filterValue === 'all') {
        // ‚úÖ Custom default ordering
        const sourceOrder = {
            "cashgenerator": 1,  // cg
            "cex": 2,
            "cashconverters": 3, // cc
            "ebay": 4
        };

        rows.sort((a, b) => {
            const sourceA = a.cells[0].textContent.trim().toLowerCase();
            const sourceB = b.cells[0].textContent.trim().toLowerCase();
            return (sourceOrder[sourceA] || 99) - (sourceOrder[sourceB] || 99);
        });
    }

    // 3Ô∏è‚É£ Render
    tbody.innerHTML = '';
    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666666; font-style: italic;">No competitor data matches filter</td></tr>';
    } else {
        rows.forEach(row => tbody.appendChild(row));
    }

    document.getElementById('competitor-number').textContent = rows.length;
}

document.getElementById('sort-price').addEventListener('change', applySortAndFilter);
document.getElementById('filter-source').addEventListener('change', applySortAndFilter);

// Update checkIrrelevantCompetitors to work with the new system
async function checkIrrelevantCompetitors(searchQuery) {
    const tbody = document.getElementById('competitor-tbody');
    const rows = [...tbody.querySelectorAll('tr')];

    const competitorList = rows
        .filter(row => row.cells.length >= 4)
        .map(row => {
            const priceText = row.cells[2].textContent.trim();
            const hasPound = priceText.includes('¬£');
            const numericPrice = hasPound
                ? parseFloat(priceText.replace(/[^0-9.-]+/g, ""))
                : null;

            return {
                title: row.cells[1].textContent.trim(),
                store: row.cells[0].textContent.trim(),
                price: numericPrice,
                hasPoundSymbol: hasPound
            };
        });

    const validPrices = competitorList
        .filter(c => c.price !== null && c.price > 0)
        .map(c => c.price);

    if (validPrices.length === 0) return;

    const mean = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
    const median = [...validPrices].sort((a, b) => a - b)[Math.floor(validPrices.length / 2)];
    const variance = validPrices.reduce((sum, price) => sum + Math.pow(price - mean, 2), 0) / validPrices.length;
    const stdDev = Math.sqrt(variance);
    const sorted = [...validPrices].sort((a, b) => a - b);
    const q1 = sorted[Math.floor(sorted.length * 0.25)];
    const q3 = sorted[Math.floor(sorted.length * 0.75)];
    const iqr = q3 - q1;

    let validIndex = 0;
    rows.forEach((row, i) => {
        if (!competitorList[i].hasPoundSymbol) return;

        let isRelevant = true;
        const price = competitorList[i].price;
        const store = competitorList[i].store.toUpperCase();
        const title = competitorList[i].title.toUpperCase();

        if (store === "CEX") {
            if (/\bA\b/.test(title)) {
                isRelevant = false;
            } else if (/\bC\b/.test(title)) {
                isRelevant = false;
            }
        }

        if (isRelevant && price !== null) {
            const lowerBound = q1 - (1.5 * iqr);
            const upperBound = q3 + (1.5 * iqr);

            if (price < lowerBound || price > upperBound) {
                isRelevant = false;
            }

            const zScore = Math.abs((price - mean) / stdDev);
            if (zScore > 2.5) {
                isRelevant = false;
            }

            const percentDiff = Math.abs((price - median) / median) * 100;
            if (percentDiff > 80) {
                isRelevant = false;
            }

            if (price < median * 0.3) {
                isRelevant = false;
            }
        }

        // Update the dropdown and cell
        const relevanceCell = row.cells[4];
        const select = relevanceCell.querySelector('.relevance-select');
        if (select) {
            select.value = isRelevant ? "Yes" : "No";
            relevanceCell.setAttribute('data-text-value', isRelevant ? "Yes" : "No");
        }
        row.setAttribute('data-relevant', isRelevant ? "Yes" : "No");
        row.style.opacity = isRelevant ? "1" : "0.3";

        validIndex++;
    });

    // ===== INITIALIZE ALL COMPETITORS AS IRRELEVANT FOR NOW, EXCEPT CEX =====
    allCompetitorRows.forEach(row => {
        const store = row.cells[0].textContent.trim().toUpperCase();
        const relevanceCell = row.cells[4];
        const select = relevanceCell.querySelector('.relevance-select');

        let isRelevant = store === "CEX"; // auto-relevant if store is CEX

        if (select) {
            select.value = isRelevant ? "Yes" : "No";
            relevanceCell.setAttribute('data-text-value', isRelevant ? "Yes" : "No");
        }

        row.setAttribute('data-relevant', isRelevant ? "Yes" : "No");
        row.style.opacity = isRelevant ? "1" : "0.3";
    });

    // ------- WE WILL REMOVE THIS BLOCK OF CODE -------------
    computeSourceAverages();
}

function computeSourceAverages() {
    const rows = allCompetitorRows; // Use all rows, not filtered DOM

    const sourceData = {};

    rows.forEach(row => {
        if (row.cells.length >= 5) {
            const isRelevant = row.cells[4].textContent.trim() === "Yes";
            if (!isRelevant) return; // skip irrelevant

            const source = row.cells[0].textContent.trim();
            const price = parseFloat(row.cells[2].textContent.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(price)) {
                if (!sourceData[source]) sourceData[source] = [];
                sourceData[source].push(price)
            }
        }
    });

    const sourceAverages = {};
    Object.keys(sourceData).forEach(source => {
        const prices = sourceData[source];
        const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
        const min = Math.min(...prices);
        const max = Math.max(...prices);
        sourceAverages[source] = {
            average: avg,
            min: min,
            max: max,
            count: prices.length
        };
    });


    // ===== Populate analysis table =====
    const tbody = document.getElementById('analysis-tbody');
    if (!tbody) return;

    // Normalize keys to uppercase for consistency
    const normalizedAverages = {};
    Object.keys(sourceAverages).forEach(key => {
        normalizedAverages[key.toUpperCase()] = sourceAverages[key];
    });

    // Grab the sources
    const cex = normalizedAverages['CEX'] || {};
    const cc = normalizedAverages['CASHCONVERTERS'] || {};
    const cg = normalizedAverages['CASHGENERATOR'] || {};

    // Suggested RRP left empty
    const suggestedRRP = '';

    // Compute CEX - 20%
    const cexMinus20 = cex.average ? `¬£${(cex.average * 0.8).toFixed(0)}` : '-';

    // Populate table
    tbody.innerHTML = `
        <tr>
            <td>${cex.average ? `¬£${cex.average.toFixed(0)}` : '-'}</td>
            <td>${cexMinus20}</td>
            <td id="rrp-cell">${suggestedRRP}</td>
            <td>${cc.min ? `¬£${cc.min.toFixed(0)}` : '-'}</td>
            <td>${cc.average ? `¬£${cc.average.toFixed(0)}` : '-'}</td>
            <td>${cg.min ? `¬£${cg.min.toFixed(0)}` : '-'}</td>
            <td>${cg.average ? `¬£${cg.average.toFixed(0)}` : '-'}</td>
        </tr>
    `;

    updateRRPCell();

}// ‚úÖ Store cost price
function setRRPAfterTable(costPrice) {
    currentCostPrice = parseFloat(costPrice);
    if (isNaN(currentCostPrice)) {
        console.warn("No valid cost price provided ‚Äî skipping RRP update.");
        currentCostPrice = null;
        return;
    }
    console.log('‚úÖ Cost price stored:', currentCostPrice);
}

function updateRRPCell() {
    if (!currentCostPrice) {
        console.warn("No cost price available to update RRP cell");
        return;
    }

    const rrpCell = document.getElementById('rrp-cell');
    if (!rrpCell) {
        console.warn("RRP cell not found in table");
        return;
    }

    // üîπ Get user-entered margin %
    const marginInput = document.getElementById('minimum-margin');
    const marginPercent = parseFloat(marginInput?.value || 37.5); // fallback to 37.5%
    const rrp = (currentCostPrice / (1 - marginPercent / 100)).toFixed(2);

    rrpCell.textContent = `¬£${rrp}`;
}

// Auto-update when margin field changes
document.addEventListener('DOMContentLoaded', () => {
    const marginInput = document.getElementById('minimum-margin');
    if (marginInput) {
        marginInput.addEventListener('input', () => {
            updateRRPCell();
        });
    }
});

// === Scroll Container Resizing Logic ===
document.addEventListener('DOMContentLoaded', function() {
  const resizeHandle = document.querySelector('.resize-handle');
  const container = document.querySelector('.analysis-scroll-container');

  if (!resizeHandle || !container) return;

  let isResizing = false;
  let startY = 0;
  let startHeight = 0;

  resizeHandle.addEventListener('mousedown', function(e) {
    isResizing = true;
    startY = e.clientY;
    startHeight = container.offsetHeight;
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    const deltaY = e.clientY - startY;
    const newHeight = startHeight - deltaY; // Drag up increases height
    const minHeight = 200;
    const maxHeight = window.innerHeight * 0.8;

    if (newHeight >= minHeight && newHeight <= maxHeight) {
      container.style.height = newHeight + 'px';
    }
  });

  document.addEventListener('mouseup', function() {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
});


{% block extra_script %}{% endblock %}

</script>

</body>
</html>