<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Pricing Analysis{% endblock %}</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  a { color: #ffffff !important; text-decoration: underline; }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    font-size: 16px;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: #000000;
    color: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-size: 0.875rem;
    overflow: hidden;
  }

  .header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #333333;
    background-color: #111111;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .header h1 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #ffffff;
    letter-spacing: 0.03em;
  }

  .main-content {
    flex: 1;
    display: flex;
    min-height: 0;
    overflow: hidden;
  }

  .input-panel {
    width: clamp(320px, 25vw, 400px);
    border-right: 1px solid #333333;
    background-color: #111111;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .competitor-panel {
    flex: 1;
    background-color: #0a0a0a;
    padding: 1.25rem;
    overflow-y: auto;
    min-width: 0;
  }

  .panel-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #888888;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .input-group {
    margin-bottom: 1rem;
  }

  .input-label {
    display: block;
    font-size: 0.6875rem;
    color: #888888;
    margin-bottom: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .input-field {
    width: 100%;
    padding: 0.75rem;
    background-color: #1a1a1a;
    border: 1px solid #333333;
    color: #ffffff;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    border-radius: 0.25rem;
  }

  .input-field:focus {
    outline: none;
    border-color: #555555;
    background-color: #222222;
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
  }

  .description-field {
    min-height: 6.25rem;
    resize: vertical;
  }

  .analyze-button {
    padding: 1rem 1.5rem;
    background-color: #ffffff;
    color: #000000;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-top: 1.25rem;
    border-radius: 0.25rem;
    width: 100%;
  }

  .analyze-button:hover:not(:disabled) {
    background-color: #e6e6e6;
  }

  .analyze-button:disabled {
    background-color: #333333;
    color: #666666;
    cursor: not-allowed;
  }

  .competitor-count {
    font-size: 0.75rem;
    color: #666666;
    margin-bottom: 1rem;
  }

  .competitor-table {
    border: 1px solid #333333;
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.25rem;
    font-size: 0.8125rem;
  }

  .competitor-table th,
  .competitor-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #333333;
  }

  .competitor-table th {
    background-color: #1a1a1a;
    color: #888888;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.6875rem;
    white-space: nowrap;
  }

  .competitor-table td {
    word-wrap: break-word;
    max-width: 0;
  }

  .competitor-table td:nth-child(2) {
    max-width: 300px;
  }

  .market-stats {
    background-color: #111111;
    padding: 1rem;
    border: 1px solid #333333;
    margin-bottom: 1.25rem;
    border-radius: 0.25rem;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.8125rem;
  }

  .stat-label {
    color: #888888;
    text-transform: uppercase;
    font-size: 0.6875rem;
  }

  .stat-value {
    color: #ffffff;
    font-weight: 600;
  }

  .warning {
    background-color: #1a1100;
    border: 1px solid #444400;
    padding: 0.75rem;
    margin-bottom: 1.25rem;
    color: #ffff88;
    font-size: 0.75rem;
    border-radius: 0.25rem;
  }

  .analysis-section {
    background-color: #111111;
    border-top: 1px solid #333333;
    padding: 1.25rem;
    max-height: 30vh;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .analysis-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .analysis-status {
    font-size: 0.75rem;
    color: #00ff00;
    font-weight: 600;
    text-transform: uppercase;
  }

  .analysis-time {
    font-size: 0.6875rem;
    color: #666666;
  }

  .recommended-price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 1.25rem;
  }

  .reasoning {
    margin-bottom: 1.25rem;
  }

  .reasoning-title {
    font-size: 0.75rem;
    color: #888888;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .reasoning-text {
    font-size: 0.8125rem;
    line-height: 1.6;
    color: #cccccc;
  }

  .controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .controls label {
    font-size: 0.6875rem;
    font-weight: 600;
    color: #888888;
    text-transform: uppercase;
    margin-right: 0.25rem;
  }

  .controls select {
    padding: 0.375rem 0.625rem;
    background-color: #1a1a1a;
    border: 1px solid #333333;
    border-radius: 0.25rem;
    color: #ffffff;
    font-size: 0.75rem;
    cursor: pointer;
    min-width: 8.75rem;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .controls select:focus {
    outline: none;
    border-color: #555555;
    background-color: #222222;
  }

  .loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #333333;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .hidden {
    display: none;
  }

  .header .menu-card {
    padding: 0.375rem 0.75rem;
    background: #444;
    color: #fff;
    border-radius: 0.25rem;
    text-decoration: none;
    font-size: 0.75rem;
    white-space: nowrap;
  }

  .header-right {
    font-size: 0.6875rem;
    color: #666666;
    white-space: nowrap;
  }
.competitor-table th:nth-child(5),
.competitor-table td:nth-child(5) {
  width: 60px;       /* narrow column width */
  text-align: center; /* visually centered */
  white-space: nowrap;
}

  .price-highlight {
    color: #00e0ff; /* cyan for averages */
  }

  .price-range {
    color: #ffaa00; /* amber for ranges */
  }

  .source-highlight {
    color: #666666;
  }


/* === SCALE FIX === */
    html {
      font-size: 14px; /* down from 16px — ~87.5% scaling */
    }

    body {
        min-height: 100vh;
        overflow-y: auto; /* allow normal scrolling */
    }

    .input-panel, .competitor-panel, .analysis-section {
      padding: 1.5rem;
    }

    .input-field,
    textarea,
    select {
      font-size: 0.8125rem;
    }

    .header h1 {
      font-size: 1rem;
    }

  {% block extra_style %}{% endblock %}
</style>
</head>
<body>

<div class="header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
  {% block back_button %}
  <a href="{% url 'home' %}" class="menu-card" style="
      padding:6px 12px;
      background:#444;
      color:#fff;
      border-radius:4px;
      text-decoration:none;
      font-size:12px;
  ">BACK TO HOME PAGE</a>
  {% endblock %}


  <h1>{% block header_title %}PRICING ANALYSIS{% endblock %}</h1>
  <div style="font-size: 11px; color: #666666;">CASH GENERATOR SYSTEM</div>
</div>

<div class="main-content">
  <div class="input-panel">
    <div class="panel-title">{% block panel_title %}INPUT PANEL{% endblock %}</div>
    {% block input_panel_content %}
        <div class="input-row">
          <div class="input-group" style="flex: 2;">
            <label class="input-label">Item Name</label>
            <input type="text" id="item-name" class="input-field" placeholder="iPhone 14" required>
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">Description</label>
          <textarea id="description" class="input-field description-field" placeholder="Good condition, minor scratches, original box included..." required></textarea>
        </div>

        <div class="input-group">
          <label class="input-label" for="urgency">Sale Urgency</label>
          <select id="urgency" class="input-field" style="cursor: pointer;">
            <option value="1">1 - No Rush (Max Profit)</option>
            <option value="2">2 - Standard Timeline</option>
            <option value="3" selected>3 - Moderate Urgency</option>
            <option value="4">4 - High Urgency</option>
            <option value="5">5 - Must Sell ASAP</option>
          </select>
        </div>


        <div class="input-group">
          <label class="input-label">Minimum Margin (%)</label>
          <input type="number" id="minimum-margin" class="input-field" placeholder="37.5" value="37.5" step="0.1" min="0" max="100">
        </div>

        <button type="button" id="analyze-btn" class="analyze-button" onclick="analyzeItem()">
          <span id="button-text">ANALYZE PRICING</span>
          <span id="button-spinner" class="loading-spinner hidden"></span>
        </button>
      {% endblock %}
  </div>

  <div class="competitor-panel">
    <div class="panel-title">COMPETITOR DATA</div>

     <div id="source-averages-header"
         style="color: #ffffff; font-weight: 600; font-size: 0.875rem; margin-bottom: 1rem; min-height: 1.2rem; text-transform: uppercase; letter-spacing: 0.03em;">
        <!-- Source averages will appear here -->
    </div>



    <div class="controls">
      <label for="sort-price">Sort by:</label>
      <select id="sort-price">
        <option value="none">None</option>
        <option value="asc">Lowest → Highest</option>
        <option value="desc">Highest → Lowest</option>
      </select>

      <label for="filter-source">Filter by:</label>
      <select id="filter-source">
        <option value="all">All Sources</option>
        <option value="CashConverters">CashConverters</option>
        <option value="CashGenerator">CashGenerator</option>
        <option value="CeX">CeX</option>
        <option value="eBay">eBay</option>
      </select>
    </div>

    <div class="competitor-count" id="competitor-count">
      SOURCES FOUND: <span id="competitor-number">0</span>
    </div>

    <table class="competitor-table" id="competitor-table">
      <thead>
        <tr>
          <th>SOURCE</th>
          <th>ITEM</th>
          <th>PRICE</th>
          <th>STORE</th>
          <th>RELEVANT?</th>
        </tr>
      </thead>
      <tbody id="competitor-tbody">
        <tr>
          <td colspan="4" style="text-align: center; color: #666666; font-style: italic;">
            {% block competitor_empty_state %}No competitor data available{% endblock %}
          </td>
        </tr>
      </tbody>
    </table>

    <div class="market-stats" id="market-stats" style="display: none;">
      <div class="stat-row">
        <span class="stat-label">MARKET RANGE:</span>
        <span class="stat-value" id="price-range">-</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">AVERAGE:</span>
        <span class="stat-value" id="price-average">-</span>
      </div>
    </div>

    <div class="warning" id="data-warning" style="display: none;">
      ⚠ LIMITED DATA<br>
      Only <span id="warning-count">0</span> competitors found. Consider additional research.
    </div>
  </div>
</div>

<div class="analysis-section" id="analysis-section" style="display: none;">
    <div class="analysis-header">
        <div class="analysis-status">{% block analysis_status %}⚡ ANALYSIS COMPLETE{% endblock %}</div>
        <div class="analysis-time" id="analysis-time">{% block analysis_time %}just now{% endblock %}</div>
    </div>

    <!-- Flex container for recommended price + source averages -->
    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <div class="recommended-price" style="margin-bottom: 0;">
            RECOMMENDED PRICE: <span id="recommended-price">-</span>
        </div>


    </div>


    <div class="reasoning">
    <div class="reasoning-title">REASONING:</div>
    <div class="reasoning-text" id="reasoning-text">
      {% block reasoning_placeholder %}Analysis will appear here...{% endblock %}
    </div>
  </div>



  {% block analysis_actions %}{% endblock %}

</div>
  {% block buying_price_panel %}{% endblock %}

{% block modals %}{% endblock %}

<script>
// Shared utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function callLocalAgent(endpoint, payload = {}) {
    const agentUrl = "http://127.0.0.1:8001"; // local FastAPI agent
    const fullUrl = `${agentUrl}${endpoint}`;
    try {
      const res = await fetch(fullUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      return res; // <-- Return the actual Response object for consistency
    } catch (err) {
      console.error("Could not connect to local automation agent:", err);
      alert("Could NOT connect to local agent, are you sure it's running?");
      return null;
    }
}


let allCompetitorRows = [];

function updateCompetitorData(competitorData, competitorCount) {
    const tbody = document.getElementById('competitor-tbody');
    const competitorNumber = document.getElementById('competitor-number');
    const marketStats = document.getElementById('market-stats');
    const dataWarning = document.getElementById('data-warning');
    const warningCount = document.getElementById('warning-count');

    competitorNumber.textContent = competitorCount;
    allCompetitorRows = [];

    if (competitorCount === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666666; font-style: italic;">No competitor data available</td></tr>';
        marketStats.style.display = 'none';
        dataWarning.style.display = 'none';
        return;
    }

    const lines = typeof competitorData === 'string' ? competitorData.trim().split('\n').filter(line => line.trim()) : competitorData;
    const prices = [];
    tbody.innerHTML = '';

    lines.forEach(line => {
        const parts = typeof line === 'string' ? line.split(' | ') : line;
        if (parts.length >= 5) {
            const competitor = typeof line === 'string' ? parts[0] : line.split(' | ')[0];
            const listingTitle = typeof line === 'string' ? parts[1] : line.split(' | ')[1];
            const price = typeof line === 'string' ? parts[2] : line.split(' | ')[2];
            const storeName = typeof line === 'string' ? parts[3] : line.split(' | ')[3];
            const url = typeof line === 'string' ? parts[4] : line.split(' | ')[4];

            const numericPrice = parseFloat(price.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(numericPrice)) prices.push(numericPrice);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${competitor}</td>
                <td><a href="${url}" target="_blank" rel="noopener noreferrer">${listingTitle}</a></td>
                <td>${price}</td>
                <td>${storeName}</td>
                <td>Yes</td>
            `;
            allCompetitorRows.push(row);
        }
    });

    if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

        document.getElementById('price-range').textContent = `£${minPrice} - £${maxPrice}`;
        document.getElementById('price-average').textContent = `£${avgPrice.toFixed(0)}`;
        marketStats.style.display = 'block';

        if (competitorCount <= 2) {
            warningCount.textContent = competitorCount;
            dataWarning.style.display = 'block';
        } else {
            dataWarning.style.display = 'none';
        }
    }

    const itemName = document.getElementById('item-name');
    applySortAndFilter();

     // Trigger AI check automatically after table is ready
    if (competitorCount > 0) {
      checkIrrelevantCompetitors(itemName.value); // <-- supply the current search query
      computeSourceAverages()
    }
}

function applySortAndFilter() {
    const tbody = document.getElementById('competitor-tbody');
    let rows = [...allCompetitorRows];

    const sortValue = document.getElementById('sort-price').value;
    const filterValue = document.getElementById('filter-source').value.toLowerCase();

    // 1️⃣ Filtering
    rows = rows.filter(row => {
        if (row.cells[0].colSpan === 4) return false;
        const source = row.cells[0].textContent.trim().toLowerCase();
        return filterValue === 'all' || source === filterValue;
    });

    // 2️⃣ Sorting
    if (sortValue !== 'none') {
        // price sort
        rows.sort((a, b) => {
            const priceA = parseFloat(a.cells[2].textContent.replace(/[^0-9.-]+/g, "")) || 0;
            const priceB = parseFloat(b.cells[2].textContent.replace(/[^0-9.-]+/g, "")) || 0;
            return sortValue === 'asc' ? priceA - priceB : priceB - priceA;
        });
    } else if (filterValue === 'all') {
        // ✅ Custom default ordering
        const sourceOrder = {
            "cashgenerator": 1,  // cg
            "cex": 2,
            "cashconverters": 3, // cc
            "ebay": 4
        };

        rows.sort((a, b) => {
            const sourceA = a.cells[0].textContent.trim().toLowerCase();
            const sourceB = b.cells[0].textContent.trim().toLowerCase();
            return (sourceOrder[sourceA] || 99) - (sourceOrder[sourceB] || 99);
        });
    }

    // 3️⃣ Render
    tbody.innerHTML = '';
    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666666; font-style: italic;">No competitor data matches filter</td></tr>';
    } else {
        rows.forEach(row => tbody.appendChild(row));
    }

    document.getElementById('competitor-number').textContent = rows.length;
}


document.getElementById('sort-price').addEventListener('change', applySortAndFilter);
document.getElementById('filter-source').addEventListener('change', applySortAndFilter);

async function checkIrrelevantCompetitors(searchQuery) {
    const tbody = document.getElementById('competitor-tbody');
    const rows = [...tbody.querySelectorAll('tr')];

    const competitorList = rows
        .filter(row => row.cells.length >= 4)
        .map(row => {
            const priceText = row.cells[2].textContent.trim();
            const hasPound = priceText.includes('£');
            const numericPrice = hasPound
                ? parseFloat(priceText.replace(/[^0-9.-]+/g, ""))
                : null;

            return {
                title: row.cells[1].textContent.trim(),
                store: row.cells[3].textContent.trim(),
                price: numericPrice,
                hasPoundSymbol: hasPound
            };
        });

    if (!competitorList.length) {
        console.log("No competitor listings found in table.");
        return;
    }

    // 🟠 Frontend auto-mark invalid prices (missing £ symbol)
    rows.forEach((row, i) => {
        if (!competitorList[i].hasPoundSymbol) {
            row.cells[4].textContent = "No £";
            row.style.opacity = "0.3";
        }
    });

    const itemDescription = document.getElementById('description')
        ? document.getElementById('description').value.trim()
        : "";

    try {
        // Only send competitors that have at least a £-style price
        const filteredCompetitors = competitorList.filter(c => c.hasPoundSymbol);

        const response = await fetch("/detect_irrelevant_competitors/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                search_query: searchQuery,
                item_description: itemDescription,
                competitor_list: filteredCompetitors
            })
        });

        const result = await response.json();
        const irrelevantIndices = result.irrelevant_indices;
        console.log("AI-flagged irrelevant:", irrelevantIndices);

        // Match filtered list back to table rows
        let validIndex = 0;
        rows.forEach((row, i) => {
            if (competitorList[i].hasPoundSymbol) {
                const isRelevant = !irrelevantIndices.includes(validIndex);
                row.cells[4].textContent = isRelevant ? "Yes" : "No";
                row.style.opacity = isRelevant ? "1" : "0.3";
                validIndex++;
            }
        });

    } catch (err) {
        console.error("Error calling AI endpoint:", err);
    }
}

function computeSourceAverages() {
    const rows = allCompetitorRows; // Use all rows, not filtered DOM

    const sourceData = {};

    rows.forEach(row => {
        if (row.cells.length >= 5) {
            const isRelevant = row.cells[4].textContent.trim() === "Yes";
            if (!isRelevant) return; // skip irrelevant

            const source = row.cells[0].textContent.trim();
            const price = parseFloat(row.cells[2].textContent.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(price)) {
                if (!sourceData[source]) sourceData[source] = [];
                sourceData[source].push(price);
            }
        }
    });

    const sourceAverages = {};
    Object.keys(sourceData).forEach(source => {
        const prices = sourceData[source];
        const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
        const min = Math.min(...prices);
        const max = Math.max(...prices);
        sourceAverages[source] = {
            average: avg,
            min: min,
            max: max,
            count: prices.length
        };
    });

    // Render at top of competitor panel
    const headerDiv = document.getElementById('source-averages-header');
    if (Object.keys(sourceAverages).length === 0) {
        headerDiv.textContent = '';
    } else {
        const parts = Object.entries(sourceAverages).map(([source, data]) => `
            <span class="source-highlight">${source}</span>:
            <span class="price-highlight">£${data.average.toFixed(0)}</span>
            <span class="price-range">(£${data.min.toFixed(0)}–£${data.max.toFixed(0)})</span>
        `);
        headerDiv.innerHTML = parts.join(' &nbsp;|&nbsp; ');
    }

    console.log("Source averages (excluding irrelevant listings):", sourceAverages);
}

{% block extra_script %}{% endblock %}

</script>

</body>
</html>