{% extends "analysis/base_item_analysis.html" %}

{% block back_button %} {% endblock %}
{% block title %}Pricing Analysis - View{% endblock %}

{% block header_title %}PRICING ANALYSIS - VIEW{% endblock %}

{% block panel_title %}ANALYSIS DATA{% endblock %}

{% block input_panel_content %}
<div class="input-row">
  <div class="input-group" style="flex: 2;">
    <label class="input-label">Item Name</label>
    <input type="text" id="item-name" class="input-field readonly-field" readonly>
  </div>
</div>

<div class="input-group">
  <label class="input-label">Description</label>
  <textarea id="description" class="input-field description-field readonly-field" readonly></textarea>
</div>

<div class="input-group">
  <label class="input-label">Serial Number</label>
  <input type="text" id="serial-number" class="input-field readonly-field" readonly>
</div>

<!-- ‚úÖ Add Analyze button here -->
<button type="button" id="analyze-btn" class="analyze-button" onclick="reanalyzeItem()">
  <span id="button-text">RE-ANALYZE PRICING FROM RELEVANT LISTINGS ONLY</span>
  <span id="button-spinner" class="loading-spinner hidden"></span>
</button>


{% endblock %}

{% block competitor_empty_state %}Select an item to view competitor data{% endblock %}

{% block analysis_status %}üìä ANALYSIS LOADED{% endblock %}

{% block analysis_time %}-{% endblock %}

{% block reasoning_placeholder %}Select an item to view analysis...{% endblock %}

{% block extra_style %}
.readonly-field {
  background-color: #0f0f0f !important;
  cursor: default;
}

{% endblock %}

{% block extra_script %}
async function loadAnalysisById(analysisId) {
    try {
        const response = await fetch(`/api/price-analysis/${analysisId}/`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('item-name').value = data.item_title || '';
            document.getElementById('description').value = data.item_description || '';
            document.getElementById('serial-number').value = data.serial_number || '';

            document.getElementById('recommended-price').textContent = `¬£${data.suggested_price}`;
            document.getElementById('reasoning-text').textContent = data.reasoning || 'No reasoning provided';

            if (data.created_at) {
                const date = new Date(data.created_at);
                document.getElementById('analysis-time').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }

            document.getElementById('analysis-section').style.display = 'block';
            if (data.cost_price) {
                console.log('Cost Price:', data.cost_price);
                setRRPAfterTable(parseFloat(data.cost_price));
            }
            updateCompetitorData(data.competitor_data || '', data.competitor_count || 0);
            return data;
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (err) {
        console.error('Error fetching analysis:', err);
        alert('Could not fetch analysis data.');
    }
}

async function reanalyzeItem() {
    const itemName = document.getElementById("item-name").value.trim();
    const description = document.getElementById("description").value.trim();
    const serialNumber = document.getElementById("serial-number").value.trim();
    const analyzeBtn = document.getElementById("analyze-btn");
    const buttonText = document.getElementById("button-text");
    const buttonSpinner = document.getElementById("button-spinner");

    if (!itemName || !description) {
        alert("Missing item details ‚Äî cannot reanalyze.");
        return;
    }

    analyzeBtn.disabled = true;
    buttonText.textContent = "Analyzing...";
    buttonSpinner.classList.remove("hidden");

    try {
        // ‚úÖ Step 1Ô∏è‚É£ ‚Äî Extract only relevant competitor listings
        const localResults = [];
        const rows = document.querySelectorAll("#competitor-table tbody tr");

        rows.forEach(row => {
            const relevantText = row.cells[4]?.textContent?.trim().toLowerCase();
            const isRelevant = ["yes", "‚úì", "true"].includes(relevantText); // ‚úÖ Only include relevant ones

            if (!isRelevant) return; // skip irrelevant rows

            const competitor = row.cells[0]?.textContent?.trim() || "Unknown";
            const title = row.cells[1]?.textContent?.trim() || "Untitled";
            const priceText = row.cells[2]?.textContent?.replace(/[¬£$,]/g, "").trim();
            const price = parseFloat(priceText) || 0.0;
            const store = row.cells[3]?.textContent?.trim() || "N/A";

            // Try to grab link if exists inside the item/title cell
            let url = "#";
            const linkEl = row.cells[1]?.querySelector("a");
            if (linkEl && linkEl.href) {
                url = linkEl.href;
            }

            localResults.push({ competitor, title, price, store, url });
        });

        if (localResults.length === 0) {
            alert("No relevant listings found ‚Äî cannot reanalyze.");
            return;
        }

        console.log("üì¶ Sending ONLY relevant listings as local_scrape_data:", localResults);

        // ‚úÖ Step 2Ô∏è‚É£ ‚Äî Send to backend (same endpoint)
        const response = await fetch("/individual-item-analyser/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
                item_name: itemName,
                description: description,
                serial_number: serialNumber,
                local_scrape_data: localResults,
                urgency: 3,
            }),
        });

        const data = await response.json();

        // ‚úÖ Step 3Ô∏è‚É£ ‚Äî Handle response
        if (data.success) {
            updateCompetitorData(data.competitor_data || "", data.competitor_count || 0);
            displayAnalysis(data.reasoning, data.suggested_price);
            console.log("‚úÖ Reanalysis complete:", data);
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error("Error during reanalysis:", error);
        alert("Reanalysis failed. Please try again.");
    } finally {
        analyzeBtn.disabled = false;
        buttonText.textContent = "RE-ANALYZE PRICING FROM RELEVANT LISTINGS ONLY";
        buttonSpinner.classList.add("hidden");
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const analysisId = urlParams.get('analysis_id');
    if (analysisId) {
        loadAnalysisById(analysisId);
    }
});

{% endblock %}