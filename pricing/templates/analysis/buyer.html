{% extends "base.html" %}

{% block title %}Buyer{% endblock %}
{% block header_title %}BUYER DASHBOARD{% endblock %}

{% block extra_style %}
:root {
  --color-bg: #111;
  --color-bg-dark: #1a1a1a;
  --color-hover-dark: #222;
  --color-white: #fff;
  --color-grey: #777;
  --color-blue: #4da6ff;
  --color-red: #ff5555;
  --color-green: #4caf50;
  --transition: 0.2s;
}

.main-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 2rem;
}
.main-content > div:first-child { text-align: center; margin-bottom: 10px; }
.main-content h3 {
  font-size: 1.6rem;
  font-weight: 700;
  margin: 30px 0 10px;
  color: var(--color-white);
}

/* Shared Input Styles */
.input-element {
  border-radius: 4px;
  border: 1px solid #333;
  transition: all var(--transition) ease;
}
.qty-input {
  width: 80px;
  padding: 6px 10px;
  background: var(--color-bg-dark);
  color: var(--color-white);
  text-align: center;
  font-size: 14px;
  -moz-appearance: textfield;
}
.qty-input::-webkit-inner-spin-button,
.qty-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.qty-input:focus { outline: none; border-color: var(--color-blue); background: var(--color-hover-dark); box-shadow: 0 0 6px rgba(77,166,255,0.3); }

.qty-btn, .modal-btn { cursor: pointer; border-radius: 3px; transition: background var(--transition); }
.qty-btn { padding: 2px 6px; margin: 0 2px; font-size: 12px; border: 1px solid #333; background: var(--color-bg-dark); color: var(--color-white); }
.qty-btn:hover { background: var(--color-hover-dark); }
.modal-btn { width: 100%; padding: 14px; background-color: var(--color-white); color: #000; font-weight: 600; border: none; text-transform: uppercase; }
.modal-btn:hover { background-color: #e0e0e0; }

/* Modal */
.modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background-color: var(--color-bg); border: 1px solid #333; border-radius: 8px; width: 400px; max-width: 90%; padding: 24px; position: relative; }
.modal-close { position: absolute; top: 12px; right: 16px; cursor: pointer; font-size: 24px; color: #888; transition: color var(--transition); }
.modal-close:hover { color: var(--color-white); }

/* Actions */
.actions-links { display: flex; flex-direction: column; gap: 6px; align-items: center; }
.actions-links a {
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 4px;
  transition: background var(--transition), color var(--transition);
}
.actions-links a.details { --color: var(--color-blue); }
.actions-links a.remove { --color: var(--color-red); }
.actions-links a.analyse { --color: var(--color-green); }
.actions-links a { color: var(--color); border: 1px solid var(--color); }
.actions-links a:hover { background: var(--color); color: #000; }

/* Item Table */
.item-table { width: 100%; border-collapse: collapse; background-color: var(--color-bg); border: 1px solid #333; border-radius: 8px; overflow: hidden; font-size: 14px; color: #ddd; margin-top: 10px; }
.item-table thead { background-color: var(--color-bg-dark); }
.item-table th, .item-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #333; }
.item-table th { font-weight: 700; color: var(--color-white); text-transform: uppercase; letter-spacing: 0.5px; }
.item-table tbody tr:hover { background-color: #1f1f1f; }
.item-table tbody tr:last-child td { border-bottom: none; }
.item-table .actions { display: flex; justify-content: center; gap: 8px; }
{% endblock %}

{% block content %}
<div class="main-content">
  <div>
    <button id="addItemBtn" class="modal-btn" style="font-size: 20px; padding:16px 32px;">Add</button>
  </div>
  <div id="tablesContainer"></div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="closeAddItemModal">&times;</span>
    <h2>Add New Item</h2>

    <label>Category</label>
    <select id="modalItemCategory" class="input-field">
      <option value="">Select category</option>
    </select>

    <label>Subcategory</label>
    <select id="modalItemSubcategory" class="input-field">
      <option value="">Select subcategory</option>
    </select>

    <label>Model</label>
    <select id="modalItemModel" class="input-field">
      <option value="">Select model</option>
      <option value="__new__">Add new model...</option>
    </select>

    <div id="attributes-container"></div>
    <button class="modal-btn" id="saveItemBtn">Save Item</button>
  </div>
</div>

<script>
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const addItemModal = document.getElementById('addItemModal');
const modalItemCategory = document.getElementById('modalItemCategory');
const modalItemSubcategory = document.getElementById('modalItemSubcategory');
const modalItemModel = document.getElementById('modalItemModel');
const saveItemBtn = document.getElementById('saveItemBtn');

const categories = {{ categories|safe }};
const categoryTables = {};
let currentAttributes = [];

/* ------------------- Helpers ------------------- */
function getCurrentAttributesPayload() {
  const payload = {};
  currentAttributes.forEach(a => payload[a.name] = document.getElementById(`attr_${a.id}`)?.value || '');
  return payload;
}

function postJSON(url, data) {
  return fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  }).then(r => r.json());
}

function setButtonState(button, {disabled, text}) {
  button.disabled = disabled;
  button.textContent = text;
}

function createQuantityCell() {
  const td = document.createElement('td');
  td.innerHTML = `<input type="number" class="qty-input" min="1" value="1">`;
  return td;
}

function createActionsCell(row) {
  const td = document.createElement('td');
  const div = document.createElement('div');
  div.className = 'actions-links';
  div.innerHTML = `
    <a href="#" class="details">Details</a>
    <a href="#" class="analyse">Analyse</a>
    <a href="#" class="remove">Remove</a>`;
  
  const [details, analyse, remove] = div.querySelectorAll('a');

  details.addEventListener('click', e => {
    e.preventDefault();
    const attributes = getCurrentAttributesPayload();
    const query = new URLSearchParams({
      categoryId: row.dataset.categoryId,
      subcategoryId: row.dataset.subcategoryId,
      modelId: row.dataset.modelId,
      attributes: JSON.stringify(attributes),
      name: row.dataset.itemName || 'Unnamed Item'
    });
    window.open('/item-buying-analyser/?' + query.toString(), '_blank');
  });

  analyse.addEventListener('click', e => { e.preventDefault(); handleAnalyseClick(row); });
  
  remove.addEventListener('click', e => {
    e.preventDefault();
    const tbody = row.parentElement;
    row.remove();
    if (!tbody.children.length) {
      tbody.innerHTML = `<tr class="placeholder"><td colspan="${tbody.parentElement.querySelectorAll('th').length}" style="text-align:center; color:#777;">No items added yet.</td></tr>`;
    }
  });

  td.appendChild(div);
  return td;
}

function createCategoryTable(catId, catName, attributes) {
  if (categoryTables[catId]) return categoryTables[catId];
  
  const table = document.createElement('table');
  table.className = 'item-table';
  const columns = ['Subcategory', 'Model', ...attributes.map(a => a.name), 'Item Name', 'Selling Price', 'Buying In Range', 'Margin', 'Quantity', 'Actions'];
  table.innerHTML = `<thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody><tr class="placeholder"><td colspan="${columns.length}" style="text-align:center; color:#777;">No items added yet.</td></tr></tbody>`;
  
  tablesContainer.append(Object.assign(document.createElement('h3'), { textContent: catName }), table);
  categoryTables[catId] = table.querySelector('tbody');
  return categoryTables[catId];
}

/* ------------------- Core ------------------- */
async function addItemToTable() {
  const catId = modalItemCategory.value;
  if (!catId) return alert("Please select a category.");
  const catName = modalItemCategory.selectedOptions[0].text;
  const subcategory = modalItemSubcategory.selectedOptions[0]?.text || '—';
  const model = modalItemModel.selectedOptions[0]?.text || '—';

  const tbody = createCategoryTable(catId, catName, currentAttributes);
  if (tbody.querySelector('.placeholder')) tbody.innerHTML = '';

  const attributesPayload = getCurrentAttributesPayload();
  let itemName = '—';

  try {
    const result = await postJSON('/api/generate_search_term/', { category: catName, model, attributes: attributesPayload });
    itemName = result.data?.generated_search_term || '—';
  } catch (e) { console.error('Error generating item name:', e); }

  const row = document.createElement('tr');
  row.dataset = { categoryId: catId, subcategoryId: modalItemSubcategory.value, modelId: modalItemModel.value, categoryName: catName, attributes: JSON.stringify(attributesPayload), itemName, subcategoryName: subcategory };
  row.innerHTML = `<td>${subcategory}</td><td>${model}</td>`;
  currentAttributes.forEach(a => row.insertAdjacentHTML('beforeend', `<td>${document.getElementById(`attr_${a.id}`)?.value || '—'}</td>`));
  row.insertAdjacentHTML('beforeend', `<td>${itemName}</td><td>—</td><td>—</td><td>—</td>`);

  row.appendChild(createQuantityCell());
  row.appendChild(createActionsCell(row));
  tbody.appendChild(row);
  addItemModal.classList.remove('active');
}

/* ------------------- Analyse ------------------- */
async function handleAnalyseClick(row) {
  const btn = row.querySelector('.analyse');
  setButtonState(btn, { disabled: true, text: 'Checking...' });
  const category = row.dataset.categoryName, model = row.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
  const attributes = JSON.parse(row.dataset.attributes || '{}');

  try {
    const check = await postJSON('/api/check_existing_items/', { category, model, attributes });
    if (!check.success) throw new Error(check.error || 'Check failed');

    if (check.competitor_count > 0) {
      setButtonState(btn, { disabled: true, text: 'Calculating Price...' });
      const priceRes = await postJSON('/api/get-selling-and-buying-price/', { category, categoryId: row.dataset.categoryId, subcategoryId: row.dataset.subcategoryId, model, attributes });
      if (!priceRes.success) throw new Error(priceRes.error || 'Price fetch failed');

      const selling = parseFloat(priceRes.selling_price), buyingStart = parseFloat(priceRes.buying_price), buyingEnd = buyingStart * 1.10;
      row.querySelector('td:nth-last-child(5)').textContent = `£${selling.toFixed(2)}`;
      row.querySelector('td:nth-last-child(4)').textContent = `£${buyingStart.toFixed(2)} - £${buyingEnd.toFixed(2)}`;
      row.querySelector('td:nth-last-child(3)').textContent = `${((selling - buyingStart)/selling*100).toFixed(1)}% - ${((selling - buyingEnd)/selling*100).toFixed(1)}%`;
    } else {
      const sourcesRes = await fetch(`/api/get-scrape-sources-for-category/?category_name=${encodeURIComponent(category)}`);
      const sources = (await sourcesRes.json()) || ['CEX','CashConverters','CashGenerator'];
      await scrapePricesForRow(row, sources);
    }
  } catch (err) {
    console.error(err);
    alert('Analyse error: ' + err.message);
  } finally {
    setButtonState(btn, { disabled: false, text: 'Analyse' });
  }
}

/* ------------------- Scraping ------------------- */
async function scrapePricesForRow(row, competitors = []) {
  const itemName = row.dataset.itemName || 'Unnamed Item';
  const attributes = Object.fromEntries(Object.entries(JSON.parse(row.dataset.attributes || '{}')).map(([k,v]) => [k.toLowerCase().replace(/\s+/g,'_'), v || '']));
  const btn = row.querySelector('.analyse');
  setButtonState(btn, { disabled: true, text: 'Scraping...' });

  try {
    const response = await sendExtensionMessage({ action:'scrape', data:{ query:itemName, competitors, category: row.dataset.categoryName, subcategory: row.dataset.subcategoryName, model: row.querySelector('td:nth-child(2)')?.textContent || '', attributes } });
    if (!response.success) throw new Error(response.error || 'Scrape failed');
    await postJSON('/save_scraped_data/', { item_name: itemName, category: parseInt(row.dataset.categoryId), item_model: parseInt(row.dataset.modelId), attributes, results: response.results });
  } catch(e){ console.error(e); alert('Scraping error: '+e.message); }
  finally { setButtonState(btn, { disabled: false, text: 'Analyse' }); }
}
</script>

{% load static %}
<script src="{% static 'analysis/add_item_modal.js' %}"></script>
{% endblock %}
