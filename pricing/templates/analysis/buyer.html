{% extends "base.html" %}

{% block title %}Buyer{% endblock %}
{% block header_title %}BUYER DASHBOARD{% endblock %}

{% block extra_style %}
.main-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 2rem;
}

/* Buttons */
.qty-btn {
  padding: 2px 6px;
  margin: 0 2px;
  cursor: pointer;
  border: 1px solid #333;
  background: #1a1a1a;
  color: #fff;
  border-radius: 3px;
  font-size: 12px;
}
.qty-btn:hover {
  background: #222;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 0.25rem;
  text-transform: uppercase;
}
.btn-sm:hover:not(:disabled) {
  background-color: #e6e6e6;
}

/* Quantity input */
.qty-input {
  padding: 2px 6px;
  background: #1a1a1a;
  border: 1px solid #333;
  color: #fff;
  border-radius: 3px;
  font-size: 12px;
  width: 50px;
  text-align: center;
}
.qty-input:focus {
  outline: none;
  border-color: #555;
  background: #222;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal.active { display: flex; }

.modal-content {
  background-color: #111;
  border: 1px solid #333;
  border-radius: 8px;
  width: 400px;
  max-width: 90%;
  padding: 24px;
  position: relative;
}

.modal-close {
  position: absolute;
  top: 12px;
  right: 16px;
  cursor: pointer;
  font-size: 24px;
  color: #888;
  transition: color 0.2s;
}
.modal-close:hover { color: #fff; }

.modal h2 {
  margin-bottom: 20px;
  font-size: 16px;
  text-transform: uppercase;
  color: #fff;
}

.modal-btn {
  width: 100%;
  padding: 14px;
  background-color: #fff;
  color: #000;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  text-transform: uppercase;
  transition: all 0.2s;
  margin-top: 16px;
}
.modal-btn:hover { background-color: #e0e0e0; }
{% endblock %}

{% block content %}
<div class="main-content">

  <h2>Add Items (by Name or Barcode)</h2>

  <div class="input-row">
    <input type="text" id="itemInput" placeholder="Enter item name or barcode">
    <button id="addItemBtn">Add</button>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Selling Price</th>
          <th>Buying In Price</th>
          <th>Margin</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="itemTableBody">
        <tr class="placeholder">
          <td colspan="6" style="text-align:center; color:#777;">No items added yet.</td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="closeAddItemModal">&times;</span>
    <h2>Add New Item</h2>

    <div class="input-group">
      <label for="modalItemName">Item Name</label>
      <input type="text" id="modalItemName" class="input-field" placeholder="Enter item name">
    </div>

    <div class="input-group">
      <label for="modalItemCategory">Category</label>
      <select id="modalItemCategory" class="input-field">
        <option value="">Select category</option>
      </select>
    </div>

    <div class="input-group">
      <label for="modalItemManufacturer">Manufacturer</label>
      <select id="modalItemManufacturer" class="input-field">
        <option value="">Select manufacturer</option>
      </select>
    </div>

    <div class="input-group">
      <label for="modalItemModel">Model</label>
      <select id="modalItemModel" class="input-field">
        <option value="">Select model</option>
      </select>
    </div>

    <div class="input-group">
      <label>Attributes</label>
      <div id="attributes-container"></div>
    </div>

    <button class="modal-btn" id="saveItemBtn">Save Item</button>
  </div>
</div>

<script>
/* ---------- Cached DOM Elements ---------- */
const addItemBtn = document.getElementById('addItemBtn');
const itemInput = document.getElementById('itemInput');
const tableBody = document.getElementById('itemTableBody');
const addItemModal = document.getElementById('addItemModal');
const closeAddItemModal = document.getElementById('closeAddItemModal');
const saveItemBtn = document.getElementById('saveItemBtn');
const modalItemName = document.getElementById('modalItemName');
const modalItemCategory = document.getElementById('modalItemCategory');
const modalItemManufacturer = document.getElementById('modalItemManufacturer');
const modalItemModel = document.getElementById('modalItemModel');
const attributesContainer = document.getElementById('attributes-container');

/* ---------- Data ---------- */
const categories = {{ categories|safe }};
let currentAttributes = [];

/* ---------- Initialization ---------- */
document.addEventListener('DOMContentLoaded', () => {
  populateCategories();
  fetchManufacturers();
});

/* ---------- Category / Manufacturer / Model ---------- */
function populateCategories() {
  modalItemCategory.innerHTML = '<option value="">Select category</option>';
  categories.forEach(cat => {
    modalItemCategory.insertAdjacentHTML('beforeend', `<option value="${cat.id}">${cat.name}</option>`);
  });
}

function fetchManufacturers() {
  fetch("{% url 'api-manufacturers' %}")
    .then(res => res.json())
    .then(data => {
      modalItemManufacturer.innerHTML = '<option value="">Select manufacturer</option>';
      data.forEach(m => {
        modalItemManufacturer.insertAdjacentHTML('beforeend', `<option value="${m.id}">${m.name}</option>`);
      });
    });
}

function fetchModels() {
  const categoryId = modalItemCategory.value;
  const manufacturerId = modalItemManufacturer.value;

  if (!categoryId || !manufacturerId) {
    modalItemModel.innerHTML = '<option value="">Select model</option>';
    return;
  }

  fetch(`/api/models/?category=${categoryId}&manufacturer=${manufacturerId}`)
    .then(res => res.json())
    .then(data => {
      modalItemModel.innerHTML = '<option value="">Select model</option>';
      data.forEach(m => {
        modalItemModel.insertAdjacentHTML('beforeend', `<option value="${m.id}">${m.name}</option>`);
      });
    });
}

/* ---------- Attributes ---------- */
async function loadCategoryAttributes(categoryId) {
  try {
    const res = await fetch(`/api/category_attributes/?category=${categoryId}`);
    const data = await res.json();
    renderAttributes(data);
    currentAttributes = data;
    updateTableHeaders(currentAttributes);
  } catch (err) {
    console.error("Error loading attributes:", err);
  }
}

function renderAttributes(attributes) {
  attributesContainer.innerHTML = '';
  attributes.forEach(attr => {
    const field =
      attr.field_type === 'select'
        ? renderSelectAttribute(attr)
        : `<input type="${attr.field_type === 'number' ? 'number' : 'text'}" id="attr_${attr.id}" class="input-field">`;
    attributesContainer.insertAdjacentHTML('beforeend', `
      <div class="input-group">
        <label>${attr.label || attr.name}</label>
        ${field}
      </div>
    `);
  });
}

function renderSelectAttribute(attr) {
  const options = (attr.options || [])
    .map(opt => `<option value="${opt}">${opt}</option>`)
    .join('');
  return `
    <select id="attr_${attr.id}" class="input-field">
      <option value="">-- Select ${attr.label || attr.name} --</option>
      ${options}
    </select>`;
}

/* ---------- Event Listeners ---------- */
modalItemCategory.addEventListener('change', () => {
  fetchModels();
  loadCategoryAttributes(modalItemCategory.value);
});

modalItemManufacturer.addEventListener('change', fetchModels);

addItemBtn.addEventListener('click', () => {
  const val = itemInput.value.trim();
  if (!val) return alert("Enter item name or barcode first.");
  modalItemName.value = val;
  resetModal();
  addItemModal.classList.add('active');
});

closeAddItemModal.addEventListener('click', () => addItemModal.classList.remove('active'));

itemInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') addItemBtn.click();
});

saveItemBtn.addEventListener('click', addItemToTable);

/* ---------- UI Helpers ---------- */
function resetModal() {
  modalItemCategory.value = '';
  modalItemManufacturer.value = '';
  modalItemModel.innerHTML = '<option value="">Select model</option>';
  attributesContainer.innerHTML = '';
}

function addItemToTable() {
  const name = modalItemName.value.trim();
  if (!name) return alert("Please enter an item name.");

  if (tableBody.querySelector('.placeholder')) tableBody.innerHTML = '';

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${name}</td>
    <td>—</td>
    <td>—</td>
    <td>—</td>
    <td>${createQuantityCell().innerHTML}</td>
  `;

  // Dynamic attributes
  currentAttributes.forEach(attr => {
    const td = document.createElement('td');
    td.textContent = document.getElementById(`attr_${attr.id}`)?.value || '—';
    row.appendChild(td);
  });

  row.appendChild(createActionsCell(row));
  tableBody.appendChild(row);
  itemInput.value = '';
  addItemModal.classList.remove('active');
}

function createQuantityCell() {
  const cell = document.createElement('td');
  cell.innerHTML = `
    <button class="qty-btn">-</button>
    <input type="number" class="qty-input" min="1" value="1">
    <button class="qty-btn">+</button>
  `;

  const [minus, input, plus] = cell.children;
  minus.addEventListener('click', () => input.value = Math.max(1, input.value - 1));
  plus.addEventListener('click', () => input.value++);
  return cell;
}

function createActionsCell(row) {
  const cell = document.createElement('td');
  cell.style.display = 'flex';
  cell.style.gap = '8px';
  cell.style.alignItems = 'center';

  const detailsBtn = document.createElement('button');
  detailsBtn.textContent = 'Details';
  detailsBtn.className = 'btn btn-sm';
  detailsBtn.addEventListener('click', () =>
    alert(`Analysing ${row.querySelector('td').textContent}`)
  );

  const removeBtn = document.createElement('button');
  removeBtn.textContent = 'Remove';
  removeBtn.className = 'btn btn-sm';
  removeBtn.style.backgroundColor = '#ff4444';
  removeBtn.style.color = '#fff';
  removeBtn.addEventListener('click', () => {
    row.remove();
    if (!tableBody.children.length) renderPlaceholder();
  });

  cell.append(detailsBtn, removeBtn);
  return cell;
}

function renderPlaceholder() {
  tableBody.innerHTML = `
    <tr class="placeholder">
      <td colspan="6" style="text-align:center; color:#777;">No items added yet.</td>
    </tr>`;
}

function updateTableHeaders(attributes = []) {
  const thead = document.querySelector('.data-table thead tr');
  const baseCols = ['Item', 'Selling Price', 'Buying In Price', 'Margin', 'Quantity'];
  thead.innerHTML = '';

  baseCols.concat(attributes.map(a => a.name)).concat(['Actions']).forEach(col => {
    thead.insertAdjacentHTML('beforeend', `<th>${col}</th>`);
  });
}
</script>
{% endblock %}
