{% extends "base.html" %}

{% block title %}Buyer{% endblock %}
{% block header_title %}BUYER DASHBOARD{% endblock %}

{% block extra_style %}
.main-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 2rem;
}

/* Center button area with tighter spacing */
.main-content > div:first-child {
  text-align: center;
  margin-bottom: 10px; /* reduced from 20px */
}

/* Category headers (h3) */
.main-content h3 {
  font-size: 1.6rem; /* bigger header text */
  font-weight: 700;
  margin-top: 30px;   /* space above header */
  margin-bottom: 10px; /* spacing between header and table */
  color: #fff;
}

/* Buttons */
.qty-btn, .modal-btn {
  cursor: pointer;
  border: 1px solid #333;
  background: #1a1a1a;
  color: #fff;
  border-radius: 3px;
  transition: background 0.2s;
}
.qty-btn { padding: 2px 6px; margin: 0 2px; font-size: 12px; }
.qty-btn:hover { background: #222; }

.modal-btn {
  width: 100%;
  padding: 14px;
  background-color: #fff;
  color: #000;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  text-transform: uppercase;
}
.modal-btn:hover { background-color: #e0e0e0; }

/* Quantity input */
.qty-input {
  width: 50px;
  text-align: center;
  background: #1a1a1a;
  border: 1px solid #333;
  color: #fff;
  border-radius: 3px;
  font-size: 12px;
}
.qty-input:focus {
  outline: none;
  border-color: #555;
  background: #222;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal.active { display: flex; }

.modal-content {
  background-color: #111;
  border: 1px solid #333;
  border-radius: 8px;
  width: 400px;
  max-width: 90%;
  padding: 24px;
  position: relative;
}
.modal-close {
  position: absolute;
  top: 12px;
  right: 16px;
  cursor: pointer;
  font-size: 24px;
  color: #888;
  transition: color 0.2s;
}
.modal-close:hover { color: #fff; }

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.data-table th, .data-table td {
  padding: 8px;
  border: 1px solid #333;
  text-align: left;
  color: #fff;
}
.data-table th { background: #222; }
.data-table td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.actions-links {
  display: flex;
  gap: 12px; /* adds space between buttons */
  justify-content: center;
}

.actions-links a {
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 4px;
  transition: background 0.2s, color 0.2s;
}

/* Details button (blue tone) */
.actions-links .details {
  color: #4da6ff;
  border: 1px solid #4da6ff;
}
.actions-links .details:hover {
  background: #4da6ff;
  color: #000;
}

/* Remove button (red tone) */
.actions-links .remove {
  color: #ff5555;
  border: 1px solid #ff5555;
}
.actions-links .remove:hover {
  background: #ff5555;
  color: #000;
}

{% endblock %}

{% block content %}
<div class="main-content">

  <div style="text-align:center; margin-bottom: 20px;">
    <button id="addItemBtn" style="padding: 16px 32px; font-size: 20px; font-weight: bold;">Add</button>
  </div>

  <div id="tablesContainer"></div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="closeAddItemModal">&times;</span>
    <h2>Add New Item</h2>

    <label>Category</label>
    <select id="modalItemCategory" class="input-field">
      <option value="">Select category</option>
    </select>

    <label>Subcategory</label>
    <select id="modalItemSubcategory" class="input-field">
      <option value="">Select subcategory</option>
    </select>

    <label>Model</label>
    <select id="modalItemModel" class="input-field">
      <option value="">Select model</option>
    </select>

    <div id="attributes-container"></div>
    <button class="modal-btn" id="saveItemBtn">Save Item</button>
  </div>
</div>



<script>
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const categories = {{ categories|safe }};


function createCategoryTable(categoryId, categoryName, attributes) {
  if (categoryTables[categoryId]) return categoryTables[categoryId];
  const table = document.createElement('table');
  table.className = 'data-table';
  const thead = document.createElement('thead');
  const columns = ['Subcategory', 'Model', ...attributes.map(a => a.name), 'Selling Price', 'Buying In Price', 'Margin', 'Quantity', 'Actions'];
  thead.innerHTML = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;
  const tbody = document.createElement('tbody');
  tbody.innerHTML = `<tr class="placeholder"><td colspan="${columns.length}" style="text-align:center; color:#777;">No items added yet.</td></tr>`;
  table.append(thead, tbody);
  tablesContainer.append(Object.assign(document.createElement('h3'), { textContent: categoryName }), table);
  categoryTables[categoryId] = tbody;
  return tbody;
}

function addItemToTable() {
  const catId = modalItemCategory.value;
  if (!catId) return alert("Please select a category.");
  const catName = modalItemCategory.options[modalItemCategory.selectedIndex]?.text;
  const manu = modalItemSubcategory.options[modalItemSubcategory.selectedIndex]?.text || '—';
  const model = modalItemModel.options[modalItemModel.selectedIndex]?.text || '—';
  const tbody = createCategoryTable(catId, catName, currentAttributes);
  if (tbody.querySelector('.placeholder')) tbody.innerHTML = '';

  const row = document.createElement('tr');
  row.innerHTML = `<td>${manu}</td><td>${model}</td>`;
  currentAttributes.forEach(a => row.insertAdjacentHTML('beforeend', `<td>${document.getElementById(`attr_${a.id}`)?.value || '—'}</td>`));
  row.insertAdjacentHTML('beforeend', `<td>—</td><td>—</td><td>—</td><td>${createQuantityCell().innerHTML}</td>`);
  row.dataset.categoryId = catId;
  row.dataset.subcategoryId = modalItemSubcategory.value;
  row.dataset.modelId = modalItemModel.value;
  row.dataset.attributes = JSON.stringify(currentAttributes.map(a => ({ id: a.id, value: document.getElementById(`attr_${a.id}`)?.value || '' })));
  row.appendChild(createActionsCell(row));
  tbody.appendChild(row);
  addItemModal.classList.remove('active');
}

function createQuantityCell() {
  const td = document.createElement('td');
  td.innerHTML = `<button class="qty-btn">-</button><input type="number" class="qty-input" min="1" value="1"><button class="qty-btn">+</button>`;
  const [minus, input, plus] = td.children;
  minus.onclick = () => input.value = Math.max(1, input.value - 1);
  plus.onclick = () => input.value++;
  return td;
}

function createActionsCell(row) {
  const td = document.createElement('td');
  const div = document.createElement('div');
  div.className = 'actions-links';
  div.innerHTML = `
    <a href="#" class="details">Details</a>
    <a href="#" class="remove">Remove</a>`;
  const [details, remove] = div.querySelectorAll('a');

  details.onclick = e => {
    e.preventDefault();

    const data = {
      categoryId: row.dataset.categoryId,
      subcategoryId: row.dataset.subcategoryId,
      modelId: row.dataset.modelId,
      attributes: JSON.parse(row.dataset.attributes)
    };

    const query = new URLSearchParams({
      categoryId: data.categoryId,
      subcategoryId: data.subcategoryId,
      modelId: data.modelId,
      attributes: JSON.stringify(data.attributes) // <-- fix here
    });

    window.open('/item-buying-analyser/?' + query.toString(), '_blank');
  };

  remove.onclick = e => {
    e.preventDefault();
    row.remove();
    const tb = row.parentElement;
    if (!tb.children.length) tb.innerHTML = `<tr class="placeholder"><td colspan="${row.parentElement.parentElement.querySelectorAll('th').length}" style="text-align:center; color:#777;">No items added yet.</td></tr>`;
  };
  td.append(div);
  return td;
}
</script>
{% load static %}
<script src="{% static 'analysis/add_item_modal.js' %}"></script>

{% endblock %}
